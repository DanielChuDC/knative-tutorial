<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scaling :: Knative Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/knative-tutorial/knative-tutorial/dev/04-scaling.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../../_/css/vendor/knative-tutorial-site.css">  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://redhat-developer-demos.github.io/knative-tutorial">Knative Tutorial</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Project</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="https://github.com/redhat-developer-demos/knative-tutorial">Knative Tutorial
              Repository</a>
            <a class="navbar-item" href="https://github.com/redhat-developer-demos/knative-tutorial/issues">Knative
              Tutorial Issue Tracker</a>
            <a class="navbar-item" href="https://github.com/openshift-cloud-functions/Documentation">OpenShift Cloud
              Functions
            </a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/rhdevelopers">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 512 512">
              <path fill="#57aaee"
                d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
              </path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header><div class="main-wrapper">
<div class="navigation-container" data-component="knative-tutorial" data-version="dev">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Knative Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#download-tutorial-sources">Download Tutorial Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="01-setup.html#kubernetes-cluster">Kubernetes Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="01-setup.html#install-knative-minikube">Install with Minikube</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-setup.html#start-minikube">Configure and Start Minikube</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-setup.html#install-knative-istio">Install Istio </a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-setup.html#install-knative-serving">Install Knative Serving</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-setup.html#install-knative-build">Install Knative Build</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-setup.html#install-knative-eventing">Install Knative Eventing</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-setup.html#set-knative-tutorial-ns">Configuring Kubernetes Namespace</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="01-setup.html#install-knative-openshift">Install with OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-setup.html#install-knative-ocp">Install on OCP</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-setup.html#install-knative-minishift">Install on Minishift</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="01-setup.html#configure-openshift-project">Configure OpenShift Project</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#setup-work-folder">Work Folder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="02-basic-fundas.html">2. Basics and Fundamentals</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-build-containers">Build Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#deploying-new-revision">Deploy a New Revision of a Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-pinning-revision">Pinning Service to a Revision</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="03-configs-and-routes.html">3. Configurations and Routes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-configs-and-routes.html#crtd-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-configs-and-routes.html#ctrd-build-containers">Build Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-configs-and-routes.html#crtd-deploy-configuration">Deploy Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-configs-and-routes.html#crtd-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-configs-and-routes.html#crtd-deploy-route">Deploy Route</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-configs-and-routes.html#crtd-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-configs-and-routes.html#crtd-deploying-new-revision">Deploy a New Revision of a Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-configs-and-routes.html#crtd-distributing-traffic">Distributing Traffic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-configs-and-routes.html#ctrd-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="04-scaling.html">4. Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#scaling-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#scaling-build-containers">Build Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#scaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#scaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#scaling-scale-to-zero">Scale to Zero</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-observer-scale-to-zero">Observing Default Scale Down</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-observer-scale-to-zero-1m">Change Scale-to-Zero Time</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-reset-to-defaults">Reset to Defaults</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#scaling-auto-scaling">Auto Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-autoscaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-autoscaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-load-service">Load Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#scaling-min-scale">Minimum Scale</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scaling-deploy-service-minscale">Deploy Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#scaling-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="05-build/build.html">5. Build</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="05-build/build.html#build-prerequisite">Prerequisites</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-build/build.html#build-edit-cr-secret">Edit Container Registry Secret</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-build/build.html#build-edit-build-spec">Edit Build Spec</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-build/build.html#build-edit-knative-service">Edit Knative Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-build/build.html#build-apply-prereq-resources">Apply Resources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-build/build.html#build-create-build">Create Build</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-build/build.html#build-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-build/build.html#build-watching-logs">Watching Logs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-build/build.html#build-build-status">Build Status</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-build/build.html#build-deploy-service-build">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-build/build.html#build-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-build/build.html#build-build-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="05-build/build-templates.html">6. Build Template</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="05-build/build-templates.html#build-template-prerequisite">Prerequisites</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-build/build-templates.html#build-template-template">Build Template</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-build/build-templates.html#build-template-edit-service">Edit Knative Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="05-build/build-templates.html#build-template-apply-resources">Apply Resources</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-build/build-templates.html#build-template-create-template">Create Build Template</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-build/build-templates.html#build-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-build/build-templates.html#build-deploy-service-build-template">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-build/build-templates.html#build-template-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-build/build-templates.html#build-template-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing.html">7. Eventing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-eventing/eventing.html#eventing-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-eventing/eventing.html#eventing-assumptions">Assumptions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-svc.html">Source to Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-source">Event Source</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-create-event-source">Create Event Source</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-verify-event-source">Verify</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-sink-service">Sink Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-gen-sink-service">Generate Service</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-deploy-sink-service">Deploy Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-sub.html">Source to Subscriber</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-channel">Channel</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-create-event-channel">Create Event Channel</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-verify-event-channel">Verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-source">Event Source</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-create-event-source">Create Event Source</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-verify-event-source">Verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-subscriber">Event Subscriber</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-create-subscriber">Create Event Subscriber</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-verify-subscriber">Verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-subscriber-service">Subscriber Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-gen-subscriber-service">Generate Service</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-deploy-subscriber-service">Deploy Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-eventing/eventing.html#eventing-watch-logs">Watching Logs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="faq.html">8. Frequently Asked Questions</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Knative Tutorial</span>
    <span class="version">dev</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Eventing with Apache Camel</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../knative-tutorial-camelk/v1.0.0/index.html">v1.0.0</a>
        </li>
        <li class="version">
          <a href="../../knative-tutorial-camelk/v1.0.0-SNAPSHOT/index.html">v1.0.0-SNAPSHOT</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Knative Tutorial</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">dev</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Knative Tutorial</a></li>
    <li class="crumb"><a href="04-scaling.html">4. Scaling</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/knative-tutorial/edit/release/0.4.0/documentation/modules/ROOT/pages/04-scaling.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Scaling</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand what scale-to-zero is and why it&#8217;s important.</p>
</li>
<li>
<p>Configure the scale-to-zero time period.</p>
</li>
<li>
<p>Configure the autoscaler.</p>
</li>
<li>
<p>Understand types of autoscaling strategies.</p>
</li>
<li>
<p>Enable concurrency based autoscaling.</p>
</li>
<li>
<p>Configure a minimum number of replicas for a service.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-prerequisite"><a class="anchor" href="#scaling-prerequisite"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following checks ensure that each chapter exercises are done with the right environment settings.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure you connect to the minikube or Minishift Docker daemon and use the right kubectl or OpenShift client.</p>
</li>
</ul>
</div>
<div id="minikube-set-env" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">eval $(minikube docker-env)</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#minikube-set-env"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="minishift-set-env" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">eval $(minishift docker-env) &amp;&amp; eval $(minishift oc-env)</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#minishift-set-env"><i class="fa fa-copy"></i></button><br/>
<div class="ulist">
<ul>
<li>
<p>Kubernetes should be v1.12+</p>
</li>
</ul>
</div>
<div id="kubectl-version" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl version</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#kubectl-version"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>OpenShift CLI should be v3.11.0+</p>
</li>
</ul>
</div>
<div id="oc-version" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc version</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#oc-version"><i class="fa fa-copy"></i></button><br/>
<div class="ulist">
<ul>
<li>
<p>Make sure to be on <code>knativetutorial</code> OpenShift project/Kubernetes namespace</p>
</li>
</ul>
</div>
<div id="right-openshift-project" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project -q</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#right-openshift-project"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>If you are not on <code>knativetutorial</code> project, use the command <code>oc project knativetutorial</code> to change to <code>knativetutorial</code> project</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-build-containers"><a class="anchor" href="#scaling-build-containers"></a>Build Containers</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have already cloned the repo and built the <code>greeter</code> service you can skip this step.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Navigate to work folder</p>
</li>
</ul>
</div>
<div id="navigate-to-work-folder" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/work</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#navigate-to-work-folder"><i class="fa fa-copy"></i></button><br/>
<div class="ulist">
<ul>
<li>
<p>Clone the application source code</p>
</li>
</ul>
</div>
<div id="clone-greeter-sources" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone <a href="https://github.com/redhat-developer-demos/knative-tutorial-greeter.git" class="bare">https://github.com/redhat-developer-demos/knative-tutorial-greeter.git</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#clone-greeter-sources"><i class="fa fa-copy"></i></button><br/>
<div class="ulist">
<ul>
<li>
<p>Build the application and container image</p>
</li>
</ul>
</div>
<div id="build-greeter" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd knative-tutorial-greeter/java/quarkus
./mvnw clean package
docker build -t dev.local/rhdevelopers/greeter:0.0.1  -f Dockerfile.all .</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#build-greeter"><i class="fa fa-copy"></i></button><br/>
<div class="ulist">
<ul>
<li>
<p>Check if images are built and available:</p>
</li>
</ul>
</div>
<div id="check-greeter-images" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker images | grep dev.local</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#check-greeter-images"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>The above command should return something like as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dev.local/rhdevelopers/greeter   0.0.1               6aa8771da8dd        2 hours ago         456MB</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-modify-configmap"><a class="anchor" href="#scaling-modify-configmap"></a>Setting Configmap Defaults</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Knative v0.4.0 changed how the default configuration map values are set and provided.
For the purposes of this section, lets apply a few defaults.</p>
</div>
<div class="listingblock text-center">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/04-scaling/knative/autoscaling-configmap.yaml">autoscaling-configmap.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: config-autoscaler
  labels:
    serving.knative.dev/release: devel
data:
  scale-to-zero-grace-period: 30s
  stable-window: 60s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Navigate to the tutorial chapter&#8217;s <code>Knative</code> folder:</p>
</div>
<div id="scaling-navigate-to-folder" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/04-scaling/knative</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-navigate-to-folder"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>The service can be deployed using the command:</p>
</div>
<div id="scaling-run-apply-cm" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knative-serving -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/{serving-repo}/knative/autoscaling-configmap.yaml">autoscaling-configmap.yaml</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-apply-cm"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="scaling-run-oc-apply-cm" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knative-serving -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/{serving-repo}/knative/autoscaling-configmap.yaml">autoscaling-configmap.yaml</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-oc-apply-cm"><i class="fa fa-copy"></i></button><br/>
</div>
</div>
<div class="sect1">
<h2 id="scaling-deploy-service"><a class="anchor" href="#scaling-deploy-service"></a>Deploy Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following snippet shows how a Knative service YAML will look like:</p>
</div>
<div class="listingblock text-center">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/02-basics/knative/service.yaml">service.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: greeter
spec:
  runLatest: <i class="conum" data-value="1"></i><b>(1)</b>
    configuration:
      revisionTemplate:
        spec:
          container:
            image: dev.local/rhdevelopers/greeter:0.0.1 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configures the Knative service to always run the latest revision of the deployment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is very important that the image is a fully qualified docker image name, including a tag. For more details on this <a href="faq.html#faq-q2" class="page">Question 2 of FAQ</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Navigate to the tutorial chapter&#8217;s <code>knative</code> folder:</p>
</div>
<div id="scaling-navigate-to-basics" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/02-basics/knative</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-navigate-to-basics"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>The service can be deployed using the command:</p>
</div>
<div id="scaling-run-apply-service" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/02-basics/knative/service.yaml">service.yaml</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-apply-service"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="scaling-run-oc-apply-service" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/02-basics/knative/service.yaml">service.yaml</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-oc-apply-service"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>After the deployment was successful of the service we should see a Kubernetes deployment like <code>greeter-5nrtv-deployment</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-invoke-service"><a class="anchor" href="#scaling-invoke-service"></a>Invoke Service</h2>
<div class="sectionbody">
<div id="minikube-svc-gateway-env" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP_ADDRESS="$(minikube ip):$(kubectl get svc istio-ingressgateway --namespace istio-system --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')"</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#minikube-svc-gateway-env"><i class="fa fa-copy"></i></button><br/>
<div id="minikube-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">http $IP_ADDRESS 'Host:greeter.knativetutorial.example.com'</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#minikube-svc-call"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="minishift-svc-gateway-env" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP_ADDRESS="$(minishift ip):$(oc get svc istio-ingressgateway --namespace istio-system --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')"</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#minishift-svc-gateway-env"><i class="fa fa-copy"></i></button><br/>
<div id="minishift-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">http $IP_ADDRESS 'Host:greeter.knativetutorial.example.com'</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#minishift-svc-call"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>The last <code>http</code> command should return a response like <strong>Hi  greeter &#8658; '9be9ccd9a2e3' : 1</strong></p>
</div>
<div class="paragraph">
<p>Check <a href="02-basic-fundas.html#see-what-you-have-deployed" class="page">deployed Knative resources</a> for more details on which Knative objects and resources have been created with the service deployment above.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-scale-to-zero"><a class="anchor" href="#scaling-scale-to-zero"></a>Configure scale-to-zero</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Assuming that <a href="#scaling-deploy-service">Greeter service</a> has been deployed, once no more traffic is seen going into that service, we&#8217;d like to scale this service down to zero replicas. That&#8217;s called <strong>scale-to-zero</strong>.</p>
</div>
<div class="paragraph">
<p>Scale-to-zero is one of the main properties making Knative a serverless platform. After a defined time of idleness (the so called <code>stable-window</code>) a revision is considered <strong>inactive</strong>. Now, all routes pointing to the now inactive revision will be pointed to the so-called <strong>activator</strong>. This reprogramming of the network is asynchronous in nature so the <code>scale-to-zero-grace-period</code> should give enough slack for this to happen. Once the <code>scale-to-zero-grace-period</code> is over, the revision will finally be scaled to zero replicas.</p>
</div>
<div class="paragraph">
<p>If another request tries to get to this revision, the activator will get it, instruct the autoscaler to create new pods for the revision as quickly as possible and buffer the request until those new pods are created.</p>
</div>
<div class="sect2">
<h3 id="scale-to-zero-formulae"><a class="anchor" href="#scale-to-zero-formulae"></a>Calculating scale-to-zero time period</h3>
<div class="paragraph">
<p>The Knative autoscaler uses the config map <strong>config-autoscaler</strong> in the <strong>knative-serving</strong> namespace for autoscaling related properties. The values of the attribute <code>stable-window</code> and <code>scale-to-zero-grace-period</code>, which we&#8217;ve seen above, are part of this config map.</p>
</div>
<div id="scaling-set-env" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">STABLE_WINDOW=`kubectl -n knative-serving get configmaps config-autoscaler -o yaml |
 yq r - data.stable-window` \
SCALE_TO_ZERO_GRACE_PERIOD=`kubectl -n knative-serving get configmaps config-autoscaler -o yaml |
 yq r - data.scale-to-zero-grace-period`</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-set-env"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="scaling-oc-set-env" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">STABLE_WINDOW=`oc -n knative-serving get configmaps config-autoscaler -o yaml |
 yq r - data.stable-window` \
SCALE_TO_ZERO_GRACE_PERIOD=`oc -n knative-serving get configmaps config-autoscaler -o yaml |
 yq r - data.scale-to-zero-grace-period`</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-oc-set-env"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph text-center">
<p>As described above, the time it takes to finally scale to zero will be <code>STABLE_WINDOW + SCALE_TO_ZERO_GRACE_PERIOD</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>scale-to-zero-grace-period is a dynamic parameter so the new value will immediately be in effect after updating the config map</p>
</li>
<li>
<p>the minimum value that can be set for <code>scale-to-zero-grace-period</code> is 30 seconds</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="scaling-observer-scale-to-zero"><a class="anchor" href="#scaling-observer-scale-to-zero"></a>Observing default scale down</h3>
<div class="paragraph">
<p>For easier observation let us open a new terminal and run the following command,</p>
</div>
<div id="watch-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch 'kubectl get pods -n knativetutorial'</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#watch-scale"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="oc-watch-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch 'oc get pods -n knativetutorial'</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#oc-watch-scale"><i class="fa fa-copy"></i></button><br/>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are on OpenShift up and downscaling can also be watched on using the OpenShift Web Console by navigating to the <code>knativetutorial</code> project
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Checking default values</p>
</div>
<div id="scaling-env-values-check" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># should return 60s
echo $STABLE_WINDOW
# should return 30s
echo $SCALE_TO_ZERO_GRACE_PERIOD</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-env-values-check"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>By default the <strong>scale-to-zero-grace-period</strong> is <code>30s</code>, and the <strong>stable-window</strong> is <code>60s</code>. Firing a request to the greeter service will bring up the pod (if it is already terminated, as described above) to serve the request. Leaving it without any further requests will automatically cause it to scale to zero in <code>1 min 30 secs</code>(<a href="#scale-to-zero-formulae">Compute scale-to-zero grace period</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="scaling-observer-scale-to-zero-1m"><a class="anchor" href="#scaling-observer-scale-to-zero-1m"></a>Scale to zero in 1 minute</h3>
<div class="paragraph">
<p>Let us now update <strong>scale-to-zero-grace-period</strong> to <code>1m</code> and leave the <strong>stable-window</strong> at the default <code>60s</code>.</p>
</div>
<div class="paragraph">
<p>Navigate to the tutorial chapter&#8217;s <code>knative</code> folder:</p>
</div>
<div id="scaling-navigate-back" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/04-scaling/knative</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-navigate-back"><i class="fa fa-copy"></i></button><br/>
<div id="scaling-run-scale-to-zero-1m" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knative-serving get cm config-autoscaler -o yaml | yq w - -s <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/04-scaling/knative/configure-scaling-to-1m.yaml">configure-scaling-to-1m.yaml</a> | kubectl apply -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-scale-to-zero-1m"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="scaling-run-oc-scale-to-zero-1m" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n knative-serving get cm config-autoscaler -o yaml | yq w - -s <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/04-scaling/knative/configure-scaling-to-1m.yaml">configure-scaling-to-1m.yaml</a> | oc apply -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-oc-scale-to-zero-1m"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>Verifying the <code>scale-to-zero-grace-period</code> value, which should return <code>1m</code>:</p>
</div>
<div id="scaling-run-verify-scale-to-zero-1m" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knative-serving get configmap config-autoscaler -o yaml \
 | yq r - data.scale-to-zero-grace-period</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-verify-scale-to-zero-1m"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="scaling-run-oc-verify-scale-to-zero-1m" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n knative-serving get configmap config-autoscaler -o yaml \
  | yq r - data.scale-to-zero-grace-period</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-oc-verify-scale-to-zero-1m"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>Now <a href="#scaling-invoke-service">firing the request</a> to the greeter service will bring up the pod to serve the request again. Leaving it without any further requests, it will automatically scale to zero in <code>2 mins</code>(<a href="#scale-to-zero-formulae">Compute scale-to-zero grace period</a>)</p>
</div>
</div>
<div class="sect2">
<h3 id="scaling-reset-to-defaults"><a class="anchor" href="#scaling-reset-to-defaults"></a>Reset scale-to-zero to defaults</h3>
<div class="paragraph">
<p>Let us revert the <code>scale-to-zero-grace-period</code> to its default:</p>
</div>
<div id="scaling-run-reset-scale-to-zero" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knative-serving get cm config-autoscaler -o yaml | yq w - -s <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/04-scaling/knative/configure-scaling-to-30s.yaml">configure-scaling-to-30s.yaml</a> | kubectl apply -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-reset-scale-to-zero"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="scaling-run-oc-reset-scale-to-zero" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n knative-serving get cm config-autoscaler -o yaml | yq w - -s <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/04-scaling/knative/configure-scaling-to-30s.yaml">configure-scaling-to-30s.yaml</a> | oc apply -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-oc-reset-scale-to-zero"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>Verifying the <code>scale-to-zero-grace-period</code> value, which should return <code>30s</code>:</p>
</div>
<div id="run-verify-scale-to-zero-defaults" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knative-serving get configmap config-autoscaler -o yaml \
 | yq r - data.scale-to-zero-grace-period</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#run-verify-scale-to-zero-defaults"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="run-oc-verify-scale-to-zero-defaults" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n knative-serving get configmap config-autoscaler -o yaml \
  | yq r - data.scale-to-zero-grace-period</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#run-oc-verify-scale-to-zero-defaults"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>For better clarity and understanding let us <a href="#scaling-cleanup">clean up</a> the deployed Knative resources before going to next section.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-auto-scaling"><a class="anchor" href="#scaling-auto-scaling"></a>Auto Scaling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default Knative Serving allows 100 concurrent requests into a pod. This is defined by the <code>container-concurrency-target-default</code> setting in the configmap <strong>config-autoscaler </strong> in the <strong>knative-serving</strong> namespace.</p>
</div>
<div class="paragraph">
<p>For this exercise let us make our service handle only <strong>10</strong> concurrent requests. This will cause Knative autoscaler to scale to more pods as soon as we run more than 10 requests in parallel against the revision.</p>
</div>
<div class="sect2">
<h3 id="scaling-concurrency-10"><a class="anchor" href="#scaling-concurrency-10"></a>Service with concurrency of 10 requests</h3>
<div class="listingblock text-center">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/04-scaling/knative/service-10.yaml">service-10.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: greeter
spec:
  runLatest:
    configuration:
      revisionTemplate:
        metadata:
          annotations:
          autoscaling.knative.dev/target: "10" <i class="conum" data-value="1"></i><b>(1)</b>
        spec:
          container:
            image: dev.local/rhdevelopers/greeter:0.0.1
            livenessProbe:
              httpGet:
                path: /healthz
            readinessProbe:
              httpGet:
                path: /healthz</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Will allow each service pod to handle max of 10 in-flight requests per pod before automatically scaling to new pod(s)</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="scaling-autoscaling-deploy-service"><a class="anchor" href="#scaling-autoscaling-deploy-service"></a>Deploy service</h3>
<div id="scaling-run-autoscale-10" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/04-scaling/knative/service-10.yaml">service-10.yaml</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-autoscale-10"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="scaling-run-oc-autoscale-10" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/04-scaling/knative/service-10.yaml">service-10.yaml</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-oc-autoscale-10"><i class="fa fa-copy"></i></button><br/>
</div>
<div class="sect2">
<h3 id="scaling-autoscaling-invoke-service"><a class="anchor" href="#scaling-autoscaling-invoke-service"></a>Invoke Service</h3>
<div id="minikube-svc-gateway-env" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP_ADDRESS="$(minikube ip):$(kubectl get svc istio-ingressgateway --namespace istio-system --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')"</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#minikube-svc-gateway-env"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="minishift-svc-gateway-env" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP_ADDRESS="$(minishift ip):$(oc get svc istio-ingressgateway --namespace istio-system --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')"</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#minishift-svc-gateway-env"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>Open a new terminal and run the following command:</p>
</div>
<div id="watch-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch 'kubectl get pods -n knativetutorial'</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#watch-scale"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="oc-watch-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch 'oc get pods -n knativetutorial'</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#oc-watch-scale"><i class="fa fa-copy"></i></button><br/>
</div>
<div class="sect2">
<h3 id="scaling-load-service"><a class="anchor" href="#scaling-load-service"></a>Load the service</h3>
<div class="paragraph">
<p>We will now send some load to the greeter service.  The command below sends 50 concurrent requests (<code>-c 50</code>) for the next 30s (<code>-t 30s</code>)</p>
</div>
<div id="scaling-run-siege" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">siege -r 1 -c 50 -t 30S \
  -H "Host:greeter.knativetutorial.example.com" \
  "http://${IP_ADDRESS}"</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-siege"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>After you&#8217;ve successfully run this small load test, you will notice the number of greeter service pods will have scaled to 5 automatically.</p>
</div>
<div class="paragraph">
<p>The autoscale pods is computed using the formula:</p>
</div>
<div class="listingblock text-center">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">totalPodsToScale = inflightRequests / concurrencyTarget</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this current setting of <strong>concurrencyTarget=10</strong>(<code>containerConcurrency: "10"</code>) and <strong>inflightRequests=50</strong> , you will see Knative automatically scales the greeter services to  <code><strong>50/10 = 5 pods</strong></code>.</p>
</div>
<div class="paragraph">
<p>For more clarity and understanding let us <a href="#scaling-cleanup">clean up</a> existing deployments before proceeding to next section.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-min-scale"><a class="anchor" href="#scaling-min-scale"></a>Minimum Scale</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In real world scenarios your service might need to handle sudden spikes in requests. Knative starts each service with a default of <strong>1</strong> replica. As described above, this will eventually be scaled to zero as described above. If your app needs to stay particularly responsive under any circumstances and/or has a long startup time, it might be beneficial to always keep a minimum number of pods around. This can be done via an the annotation <strong>autoscaling.knative.dev/minScale</strong>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to make Knative create services that start with a replica count of <strong>2</strong> and never scale below it.</p>
</div>
<div class="sect2">
<h3 id="scaling-deploy-service-minscale"><a class="anchor" href="#scaling-deploy-service-minscale"></a>Deploy service</h3>
<div class="listingblock text-center">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/04-scaling/knative/service-min-scale.yaml">service-min-scale.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: greeter
spec:
  runLatest:
    configuration:
      revisionTemplate:
        metadata:
          annotations:
            autoscaling.knative.dev/minScale: "2" <i class="conum" data-value="1"></i><b>(1)</b>
            # Target 10 in-flight-requests per pod.
            autoscaling.knative.dev/target: "10" <i class="conum" data-value="2"></i><b>(2)</b>
        spec:
          containerConcurrency: 10
          container:
            image: dev.local/rhdevelopers/greeter:0.0.1
            livenessProbe:
              httpGet:
                path: /healthz
            readinessProbe:
              httpGet:
                path: /healthz</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The deployment of this service will always have a minimum of 2 pods.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Will allow each service pod to handle max of 10 in-flight requests per pod before automatically scaling to new pods.</td>
</tr>
</table>
</div>
<div id="scaling-run-min-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/04-scaling/knative/service-min-scale.yaml">service-min-scale.yaml</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-min-scale"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="scaling-run-oc-min-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/04-scaling/knative/service-min-scale.yaml">service-min-scale.yaml</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#scaling-run-min-scale"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>After the deployment was successful we should see a Kubernetes Deployment called <code>greeter-00001-deployment</code> with <strong>two</strong> pods available.</p>
</div>
<div class="paragraph">
<p>Open a new terminal and run the following command :</p>
</div>
<div id="watch-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch 'kubectl get pods -n knativetutorial'</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#watch-scale"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="oc-watch-scale" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch 'oc get pods -n knativetutorial'</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#oc-watch-scale"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>Let us <a href="#scaling-load-service">send some load to the service</a> to trigger autoscaling.</p>
</div>
<div class="paragraph">
<p>When all requests are done and if we are beyond the <code>scale-to-zero-grace-period</code>, we will notice that Knative has terminated only 3 out 5 pods. This is because we have configured Knative to always run two pods via the annotation <code>autoscaling.knative.dev/minScale: "2"</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-cleanup"><a class="anchor" href="#scaling-cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div id="run-scaling-cleanup" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial delete services.serving.knative.dev greeter</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#run-scaling-cleanup"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="run-oc-scaling-cleanup" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n knativetutorial delete services.serving.knative.dev greeter</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#run-oc-scaling-cleanup"><i class="fa fa-copy"></i></button><br/>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This content is brought to you by <a href="http://developers.redhat.com">Red Hat Developer</a> - Register today!.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
<script src="../../_/js/vendor/clipboard.min.js"></script>
<script>
    var clipboard = new ClipboardJS('.copybtn');

    clipboard.on('success', function (e) {
        console.info('Text:', e);
        //e.clearSelection();        
    });

    clipboard.on('error', function (e) {
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
    });
</script>  </body>
</html>
