<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knative Workshop :: Knative Workshop</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/knative-tutorial/knative-tutorial/workshop-v0.4.0/03-configs-and-routes.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../../_/css/vendor/knative-tutorial-site.css">  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://redhat-developer-demos.github.io/knative-tutorial">Knative Workshop</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Project</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="https://github.com/redhat-developer-demos/knative-tutorial">Knative Tutorial
              Repository</a>
            <a class="navbar-item" href="https://github.com/redhat-developer-demos/knative-tutorial/issues">Knative
              Tutorial Issue Tracker</a>
            <a class="navbar-item" href="https://github.com/openshift-cloud-functions/Documentation">OpenShift Cloud
              Functions
            </a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/rhdevelopers">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 512 512">
              <path fill="#57aaee"
                d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
              </path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header><div class="main-wrapper">
<div class="navigation-container" data-component="knative-tutorial" data-version="workshop-v0.4.0">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Knative Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="01-setup.html#download-tutorial-sources">Download Tutorial Sources</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#configure-openshift-project">Configure OpenShift Project</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="02-basic-fundas.html">2. Basics and Fundamentals</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#deploying-new-revision">Deploy a New Revision of a Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-pinning-revision">Pinning Service to a Revision</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-basic-fundas.html#basics-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="03-configs-and-routes.html">3. Configurations and Routes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-deploy-configuration">Deploy Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-deploy-route">Deploy Route</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-deploying-new-revision">Deploy a New Revision of a Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-distributing-traffic">Distributing Traffic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#ctrd-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="04-scaling.html">4. Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-scaling.html#scaling-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-scaling.html#scaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-scaling.html#scaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="04-scaling.html#scaling-scale-to-zero">Scale to Zero</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-scaling.html#scaling-observer-scale-to-zero">Observing Default Scale Down</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-scaling.html#scaling-observer-scale-to-zero-1m">Change Scale-to-Zero Time</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-scaling.html#scaling-reset-to-defaults">Reset to Defaults</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="04-scaling.html#scaling-auto-scaling">Auto Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-scaling.html#scaling-autoscaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-scaling.html#scaling-autoscaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-scaling.html#scaling-load-service">Load Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="04-scaling.html#scaling-min-scale">Minimum Scale</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-scaling.html#scaling-deploy-service-minscale">Deploy Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-scaling.html#scaling-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing.html">5. Eventing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-eventing/eventing.html#eventing-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-svc.html">Source to Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-source">Event Source</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-create-event-source">Create Event Source</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-verify-event-source">Verify</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-sink-service">Sink Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-gen-sink-service">Generate Service</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-deploy-sink-service">Deploy Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-svc.html#eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-sub.html">Source to Subscriber</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-channel">Channel</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-create-event-channel">Create Event Channel</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-verify-event-channel">Verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-source">Event Source</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-create-event-source">Create Event Source</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-verify-event-source">Verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-subscriber">Event Subscriber</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-create-subscriber">Create Event Subscriber</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-verify-subscriber">Verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-see-what-you-have-deployed">See What You Have Deployed</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-subscriber-service">Subscriber Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-gen-subscriber-service">Generate Service</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-deploy-subscriber-service">Deploy Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-eventing/eventing-src-sub.html#eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-eventing/eventing.html#eventing-watch-logs">Watching Logs</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Knative Tutorial</span>
    <span class="version">workshop-v0.4.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Knative Tutorial</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">workshop-v0.4.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Knative Tutorial</a></li>
    <li class="crumb"><a href="03-configs-and-routes.html">3. Configurations and Routes</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/knative-tutorial/edit/workshop/0.4/documentation/modules/ROOT/pages/03-configs-and-routes.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Knative Workshop</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to understand and know how to :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploy Knative configurations and routes separately.</p>
</li>
<li>
<p>Distribute traffic between revisions of a service.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-prerequisite"><a class="anchor" href="#crtd-prerequisite"></a>Prerequisite</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following checks ensure that each chapter exercises are done with the right environment settings.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OpenShift CLI should be <code>v4.1+</code></p>
</li>
</ul>
</div>
<div id="oc-version" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc version</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#oc-version"><i class="fa fa-copy"></i></button><br/>
<div class="ulist">
<ul>
<li>
<p>Make sure to be on <code>$WORKSHOP_USER-knativetutorial</code> OpenShift project</p>
</li>
</ul>
</div>
<div id="right-openshift-project" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project -q</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#right-openshift-project"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>If you are not on <code>$WORKSHOP_USER-knativetutorial</code> OpenShift project, then use the following command to change to <code>$WORKSHOP_USER-knativetutorial</code> project:</p>
</div>
<div id="change-openshift-project" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project $WORKSHOP_USER-knativetutorial</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#change-openshift-project"><i class="fa fa-copy"></i></button><br/>
</div>
</div>
<div class="sect1">
<h2 id="crtd-deploy-configuration"><a class="anchor" href="#crtd-deploy-configuration"></a>Deploy Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous chapter we saw how we can deploy services using a holistic service resource file, in this chapter we will see how to deploy the service using configurations and route files.</p>
</div>
<div class="paragraph">
<p>Navigate to the tutorial chapter&#8217;s folder:</p>
</div>
<div id="navigate-crtd-folder" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/03-configs-and-routes</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#navigate-crtd-folder"><i class="fa fa-copy"></i></button><br/>
<div class="sect2">
<h3 id="_deploy_configuration_revision_1"><a class="anchor" href="#_deploy_configuration_revision_1"></a>Deploy Configuration revision 1</h3>
<div class="paragraph">
<p>The following snippet shows how a Knative configuration resource YAML looks like:</p>
</div>
<div class="listingblock text-center">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/config/configuration-rev1.yaml">configuration-rev1.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Configuration
metadata:
  name: greeter
spec:
  revisionTemplate:
    metadata:
      labels:
        app: greeter
    spec:
      container:
        image: quay.io/rhdevelopers/knative-tutorial-greeter:quarkus <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p>The service is then deployed using:</p>
</div>
<div id="crtd-run-oc-apply-config-rev1" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n $WORKSHOP_USER-knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/config/configuration-rev1.yaml">config/configuration-rev1.yaml</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#crtd-run-oc-apply-config-rev1"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>After the deployment was successful, we should see a kubernetes deployment like <code>greeter-wlcn4-deployment</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-invoke-service"><a class="anchor" href="#crtd-invoke-service"></a>Invoke Service</h2>
<div class="sectionbody">
<div id="minishift-svc-gateway-env" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">SVC_URL="$(oc get ksvc greeter | awk 'NR==2{print $2}')"</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#minishift-svc-gateway-env"><i class="fa fa-copy"></i></button><br/>
<div id="minishift-svc-call" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -v $SVC_URL</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#minishift-svc-call"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>The command will return <code>HTTP 404</code> as there are no routes deployed yet. Let us now deploy a route.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-deploy-route"><a class="anchor" href="#crtd-deploy-route"></a>Deploy Route</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let us now deploy a route that will route all the traffic to the configuration we just deployed.</p>
</div>
<div class="listingblock text-center">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_default.yaml">route_default.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Route
metadata:
  name: greeter
spec:
  traffic:
    - configurationName: greeter
      percent: 100</code></pre>
</div>
</div>
<div id="crtd-run-oc-apply-route-default" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n $WORKSHOP_USER-knativetutorial -f <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_default.yaml">route/route_default.yaml</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#crtd-run-oc-apply-route-default"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><a href="#crtd-invoke-service">Invoking Service</a> now should return a response like <strong>Hi  greeter &#8658; '9be9ccd9a2e3' : 1</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Sometimes the response might not be returned immediately especially when the pod is coming up from a dormant state. You might need to be a little patient :) .
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-see-what-you-have-deployed"><a class="anchor" href="#crtd-see-what-you-have-deployed"></a>See what you have deployed</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As we did not deploy a service this time</p>
</div>
<div class="sect2">
<h3 id="crtd-show-knative-services"><a class="anchor" href="#crtd-show-knative-services"></a>service</h3>
<div id="oc-knative-services" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n $WORKSHOP_USER-knativetutorial  get services.serving.knative.dev greeter</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#oc-knative-services"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>will throw an error as there are no knative services is deployed as part of the <em>configuration + routes</em> based deployment strategy.</p>
</div>
</div>
<div class="sect2">
<h3 id="crtd-show-knative-configs"><a class="anchor" href="#crtd-show-knative-configs"></a>configuration</h3>
<div id="oc-knative-configs" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n $WORKSHOP_USER-knativetutorial get configurations.serving.knative.dev greeter</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#oc-knative-configs"><i class="fa fa-copy"></i></button><br/>
</div>
<div class="sect2">
<h3 id="crtd-show-knative-routes"><a class="anchor" href="#crtd-show-knative-routes"></a>routes</h3>
<div id="oc-knative-routes" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n $WORKSHOP_USER-knativetutorial get routes.serving.knative.dev greeter</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#oc-knative-routes"><i class="fa fa-copy"></i></button><br/>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>The domain suffix in this case <strong>guru.devx.red</strong> is the OpenShift Router domain which gets automatically assigned once the Knative Service is created.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="crtd-show-knative-revisions"><a class="anchor" href="#crtd-show-knative-revisions"></a>revisions</h3>
<div id="oc-knative-config-revisions" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n $WORKSHOP_USER-knativetutorial get rev -l serving.knative.dev/configuration=greeter --sort-by="{.metadata.creationTimestamp}"</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#oc-knative-config-revisions"><i class="fa fa-copy"></i></button><br/>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>add <code>-oyaml</code> to the commands above to see more details</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-deploying-new-revision"><a class="anchor" href="#crtd-deploying-new-revision"></a>Deploy a new revision</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Knative follows a revision model for its configurations. Each time you change something in the <code>revisionTemplate</code> Knative will effectively generate a new revision and thus a new deployment. In this example we add a new environment variable to demonstrate that mechanism.</p>
</div>
<div class="sect2">
<h3 id="_deploy_configuration_revision_2"><a class="anchor" href="#_deploy_configuration_revision_2"></a>Deploy configuration revision 2</h3>
<div class="listingblock text-center">
<div class="title"><a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/config/configuration-rev2.yaml">configuration-rev2.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Configuration
metadata:
  name: greeter
spec:
  revisionTemplate:
    metadata:
      labels:
        app: greeter
    spec:
      container:
        image: quay.io/rhdevelopers/knative-tutorial-greeter:quarkus
        env: <i class="conum" data-value="1"></i><b>(1)</b>
          - name: MESSAGE_PREFIX
            value: Namaste</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adding an environment variable that will be used a message prefix.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let us deploy the new revision using the command:</p>
</div>
<div id="ctrd-run-oc-apply-config-rev2" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n $WORKSHOP_USER-knativetutorial -f  <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/config/configuration-rev2.yaml">config/configuration-rev2.yaml</a></code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-run-oc-apply-config-rev2"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>After the deployment was successful we should see a kubernetes deployment like <code>greeter-tb57l-deployment</code>.</p>
</div>
<div class="paragraph">
<p>Now running the <a href="#crtd-show-knative-revisions">show revisions command</a> will list all the revisions sorted in descending order of its creation.</p>
</div>
<div class="paragraph">
<p><a href="#crtd-invoke-service">Invoking Service</a> will now show an output like <strong>Namaste  greeter &#8658; '9be9ccd9a2e3' : 1</strong>, where <em>Namaste</em> is the value that we configured for <code>MESSAGE_PREFIX</code> via environment variable in the Knative service resource file.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-distributing-traffic"><a class="anchor" href="#crtd-distributing-traffic"></a>Distributing traffic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When deploying services with service object based approach, the service resource will take care of traffic distribution either 100% to latest or pinned revision. In this section we will explore how we can deploy routes to distribute traffic between deployed revisions.</p>
</div>
<div class="paragraph">
<p>Before we start to apply routes, let us open a new terminal and poll the service. Poll  command will keep sending requests to greeter route every three seconds which allows us to monitor the changes to the responses as we keep applying the route that will distribute the traffic between the available two revisions.</p>
</div>
<div class="sect2">
<h3 id="ctrd-traffic-distribution-polling"><a class="anchor" href="#ctrd-traffic-distribution-polling"></a>Polling the service</h3>
<div class="paragraph">
<p>We need to run the service invocation in loop to see the results of traffic distribution.</p>
</div>
<div id="crtd-poll-sh" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash
set -eu
while true
do
  curl $SVC_URL
  sleep 3
done;</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#crtd-poll-sh"><i class="fa fa-copy"></i></button><br/>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Copy and save the above contents to a script file e.g. <code>$TUTORIAL_HOME/work/poll.sh</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="crtd-define-revisions"><a class="anchor" href="#crtd-define-revisions"></a>Define revisions</h3>
<div class="paragraph">
<p>For easier explanation and understanding lets give logical names to the revision and set them to environment variables:</p>
</div>
<div id="ctrd-def-oc-revisions" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">REVISION_1=`oc -n knativetutorial get rev -l serving.knative.dev/configuration=greeter --sort-by="{.metadata.creationTimestamp}" | awk 'NR==2{print $1}'`
REVISION_2=`oc -n knativetutorial get rev -l serving.knative.dev/configuration=greeter --sort-by="{.metadata.creationTimestamp}" | awk 'NR==3{print $1}'`</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-def-oc-revisions"><i class="fa fa-copy"></i></button><br/>
</div>
<div class="sect2">
<h3 id="crtd-all-rev1"><a class="anchor" href="#crtd-all-rev1"></a>Send all traffic to revision 1</h3>
<div id="ctrd-run-all-to-rev1" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_all_rev1.yaml">route/route_all_rev1.yaml</a> | yq w - 'spec.traffic[0].revisionName' $REVISION_1 | kubectl apply -n $WORKSHOP_USER-knativetutorial -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-run-all-to-rev1"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="ctrd-run-oc-all-to-rev1" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_all_rev1.yaml">route/route_all_rev1.yaml</a> | yq w - 'spec.traffic[0].revisionName' $REVISION_1 | oc apply -n $WORKSHOP_USER-knativetutorial -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-run-oc-all-to-rev1"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>If <a href="#crtd-poll-sh">poll the service</a> for some time,  you will notice the service always goes to your revision 1 e.g output will be something like <strong>Hi  greeter &#8658; '9be9ccd9a2e3' : 1</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="crtd-all-rev2"><a class="anchor" href="#crtd-all-rev2"></a>Send all traffic to revision 2</h3>
<div id="ctrd-run-all-to-rev2" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_all_to_revision.yaml">route/route_all_to_revision.yaml</a> | yq w - 'spec.traffic[0].revisionName' $REVISION_2 | kubectl apply -n $WORKSHOP_USER-knativetutorial -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-run-all-to-rev2"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="ctrd-run-oc-all-to-rev2" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_all_to_revision.yaml">route/route_all_to_revision.yaml</a> | yq w - 'spec.traffic[0].revisionName' $REVISION_2 | oc apply -n $WORKSHOP_USER-knativetutorial -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-run-oc-all-to-rev2"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>If <a href="#crtd-poll-sh">poll the service</a> for some time,  you will notice the service always goes to your revision 2 e.g output will be something like <strong>Namaste  greeter &#8658; '9be9ccd9a2e3' : 1</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="crtd-all-rev1-rev2-50"><a class="anchor" href="#crtd-all-rev1-rev2-50"></a>50-50 split between revision 1 and revision 2</h3>
<div id="ctrd-run-rev1-rev2-50" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_rev1-50_rev2-50.yaml">route/route_rev1-50_rev2-50.yaml</a> | yq w - 'spec.traffic[0].revisionName' $REVISION_1 | yq w - 'spec.traffic[1].revisionName' $REVISION_2 | kubectl apply -n $WORKSHOP_USER-knativetutorial -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-run-rev1-rev2-50"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="ctrd-run-oc-rev1-rev2-50" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_rev1-50_rev2-50.yaml">route/route_rev1-50_rev2-50.yaml</a> | yq w - 'spec.traffic[0].revisionName' $REVISION_1 | yq w - 'spec.traffic[1].revisionName' $REVISION_2 |  oc apply -n $WORKSHOP_USER-knativetutorial -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-run-oc-rev1-rev2-50"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>If <a href="#crtd-poll-sh">poll the service</a> for some time,  you will notice the service is distributed between revision 1 and revision 2 e.g output will be mix of responses like <strong>Hi  greeter &#8658; '9be9ccd9a2e3' : 1</strong> and <strong>Namaste  greeter &#8658; '9be9ccd9a2e3' : 1</strong>. You will also notice the traffic is distributed approximately 50% between the two revisions.</p>
</div>
</div>
<div class="sect2">
<h3 id="crtd-all-rev1-rev2-75-25"><a class="anchor" href="#crtd-all-rev1-rev2-75-25"></a>75-25 split between revision 1 and revision 2</h3>
<div id="ctrd-run-rev1-rev2-75-25" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_rev1-75_rev2-25.yaml">route/route_rev1-75_rev2-25.yaml</a> | yq w - 'spec.traffic[0].revisionName' $REVISION_1 | yq w - 'spec.traffic[1].revisionName' $REVISION_2 | kubectl apply -n $WORKSHOP_USER-knativetutorial -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-run-rev1-rev2-75-25"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="ctrd-run-oc-rev1-rev2-75-25" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_rev1-75_rev2-25.yaml">route/route_rev1-75_rev2-25.yaml</a> | yq w - 'spec.traffic[0].revisionName' $REVISION_1 | yq w - 'spec.traffic[1].revisionName' $REVISION_2 |  oc apply -n $WORKSHOP_USER-knativetutorial -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-run-oc-rev1-rev2-75-25"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>If <a href="#crtd-poll-sh">poll the service</a> for some time,  you will notice the service is distributed between revision 1 and revision 2 e.g output will be mix of responses like <strong>Hi  greeter &#8658; '9be9ccd9a2e3' : 1</strong> and <strong>Namaste  greeter &#8658; '9be9ccd9a2e3' : 1</strong>. You will also notice the traffic is distributed approximately 75-25% between the two revisions.</p>
</div>
</div>
<div class="sect2">
<h3 id="crtd-all-rev1-rev2-10-90"><a class="anchor" href="#crtd-all-rev1-rev2-10-90"></a>10-90 split between revision 1 and revision 2</h3>
<div id="ctrd-run-rev1-rev2-10-90" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_rev1-10_rev2-90.yaml">route/route_rev1-10_rev2-90.yaml</a> | yq w - 'spec.traffic[0].revisionName' $REVISION_1 | yq w - 'spec.traffic[1].revisionName' $REVISION_2 | kubectl apply -n $WORKSHOP_USER-knativetutorial -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-run-rev1-rev2-10-90"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p><strong>(OR)</strong></p>
</div>
<div id="ctrd-run-oc-rev1-rev2-10-90" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat <a href="https://github.com/redhat-developer-demos/knative-tutorial/blob/master/03-configs-and-routes/route/route_rev1-10_rev2-90.yaml">route/route_rev1-10_rev2-90.yaml</a> | yq w - 'spec.traffic[0].revisionName' $REVISION_1 | yq w - 'spec.traffic[1].revisionName' $REVISION_2 |  oc apply -n $WORKSHOP_USER-knativetutorial -f -</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#ctrd-run-oc-rev1-rev2-10-90"><i class="fa fa-copy"></i></button><br/>
<div class="paragraph">
<p>If <a href="#crtd-poll-sh">poll the service</a> for some time,  you will notice the service is distributed between revision 1 and revision 2 e.g output will be mix of responses like <strong>Hi  greeter &#8658; '9be9ccd9a2e3' : 1</strong> and <strong>Namaste  greeter &#8658; '9be9ccd9a2e3' : 1</strong>. You will also notice the traffic is distributed approximately 75-25% between the two revisions.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ctrd-cleanup"><a class="anchor" href="#ctrd-cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div id="crtd-run-oc-cleanup" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n $WORKSHOP_USER-knativetutorial delete configurations.serving.knative.dev greeter
oc -n $WORKSHOP_USER-knativetutorial delete routes.serving.knative.dev greeter</code></pre>
</div>
</div>
<button class="copybtn" title="Copy to clipboard" data-clipboard-target="#crtd-run-oc-cleanup"><i class="fa fa-copy"></i></button><br/>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This content is brought to you by <a href="http://developers.redhat.com">Red Hat Developer</a> - Register today!.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
<script src="../../_/js/vendor/clipboard.min.js"></script>
<script>
    var clipboard = new ClipboardJS('.copybtn');

    clipboard.on('success', function (e) {
        console.info('Text:', e);
        //e.clearSelection();        
    });

    clipboard.on('error', function (e) {
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
    });
</script>  </body>
</html>
