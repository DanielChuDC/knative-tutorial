<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurations and Routes :: Knative Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/knative-tutorial/knative-tutorial/dev/02configs-and-routes.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial">Knative Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="knative-tutorial" data-version="dev">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Knative Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction to Istio Tutorial</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#download-tutorial-sources">Download Tutorial Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#minishift">Setup MiniShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#admission-controller-webhook">Enable Admission Controller Webhook </a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#setup-knative">Setup Knative</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#install-istio">Install Istio</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#install-knative-build">Install Knative Build</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#install-knative-serving">Install Knative Serving</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#install-knative-eventing">Install Eventing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#configure-openshift-project">Configure OpenShift project</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#setup-work-folder">Work Folder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="01basic-fundas.html">2. Basics and Fundamentals</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01basic-fundas.html#basics-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01basic-fundas.html#basics-build-containers">Build Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01basic-fundas.html#basics-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01basic-fundas.html#basics-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01basic-fundas.html#basics-see-what-you-have-deployed">See what you have deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01basic-fundas.html#deploying-new-revision">Deploy new Revision Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01basic-fundas.html#basics-pinning-revision">Pinning service to a revision</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01basic-fundas.html#basics-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="02configs-and-routes.html">3. Configurations and Routes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#ctrd-build-containers">Build Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-deploy-configuration">Deploy Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-deploy-route">Deploy Route</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-see-what-you-have-deployed">See what you have deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-deploying-new-revision">Deploy new Revision Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crtd-distributing-traffic">Distributing Traffic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#ctrd-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="03scaling.html">4. Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03scaling.html#scaling-prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03scaling.html#scaling-build-containers">Build Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03scaling.html#scaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03scaling.html#scaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="03scaling.html#scaling-scale-to-zero">Scale to Zero</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03scaling.html#scaling-observer-scale-to-zero">Observing default scale down </a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03scaling.html#scaling-observer-scale-to-zero-1m">Change scale to zero time</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03scaling.html#scaling-reset-to-defaults">Reset to Defaults</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="03scaling.html#scaling-auto-scaling">Auto Scaling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03scaling.html#scaling-autoscaling-deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03scaling.html#scaling-autoscaling-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03scaling.html#scaling-load-service">Load Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="03scaling.html#scaling-min-scale">Minimum Scale</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03scaling.html#scaling-deploy-service-minscale">Deploy service </a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03scaling.html#scaling-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="04build.html">5. Build</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="04build.html#build-prerequisite">Prerequisites</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04build.html#build-create-docker-secret">Generate Docker Secret</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04build.html#build-generate-build-spec">Generate Build Spec</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04build.html#build-generate-knative-service">Generate Knative service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04build.html#build-apply-preeq-resouces">Apply Resources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04build.html#build-create-build">Create Build</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04build.html#build-see-what-you-have-deployed">See what you have deployed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04build.html#build-watching-logs">Watching logs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04build.html#build-build-status">Build Status</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04build.html#build-deploy-service-build">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04build.html#build-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04build.html#build-build-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="05build-templates.html">6. Build Template</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="05build-templates.html#build-template-prerequisite">Prerequisites</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05build-templates.html#build-template-generate-template">Generate build template</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05build-templates.html#build-template-generate-service">Generate Knative service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05build-templates.html#build-template-apply-resources">Apply Resources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="05build-templates.html#build-template-create-template">Create Build Template</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05build-templates.html#build-see-what-you-have-deployed">See what you have deployed</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05build-templates.html#build-deploy-service-build-template">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05build-templates.html#build-template-invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05build-templates.html#build-template-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="faq.html">Frequently Asked Questions</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Knative Tutorial</span>
    <span class="version">dev</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Knative Tutorial</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">dev</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Knative Tutorial</a></li>
    <li class="crumb"><a href="02configs-and-routes.html">3. Configurations and Routes</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/kameshs/git/kameshsampath/knative-tutorial/documentation/modules/ROOT/pages/02configs-and-routes.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Configurations and Routes</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to understand and know how to :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploying Knative configurations and routes separately</p>
</li>
<li>
<p>Distributing traffic between revisions of the service</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-prerequisite"><a class="anchor" href="#crtd-prerequisite"></a>Prerequisite</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following checks ensures that each chapter exercises are done with right environment settings.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure to be connected to minishift docker daemon and using right openshift client.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">eval $(minishift docker-env) &amp;&amp; eval $(minishift oc-env)</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure right OpenShift and kubernetes client are used.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># oc v3.11.0+0cbc58b kubernetes v1.11.0+d4cacc0
oc version</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># kubernetes v1.11+
kubectl version</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure right maven version is used (only for Java exercises)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># right maven version Apache Maven 3.5.x or above
./mvnw --version</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure to be on <code>knativetutorial</code> OpenShift project/kubernetes namespace</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># verify to return knativetutorial
oc project -q</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are not on <code>knativetutorial</code> project, use the command <code>oc project knativetutorial</code> to change to <code>knativetutorial</code> project</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ctrd-build-containers"><a class="anchor" href="#ctrd-build-containers"></a>Build Containers</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Navigate to work folder</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>cd $TUTORIAL_HOME/work</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the application source code</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone https://github.com/redhat-developer-demos/knative-tutorial-greeter.git</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Build the application and container image</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd knative-tutorial-greeter/java/springboot
./mvnw clean package
docker build -t dev.local/rhdevelopers/greeter:0.0.1 .</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Check if images are built and available:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker images | grep dev.local</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command should return something like as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># dev.local/rhdevelopers/greeter   0.0.1               6aa8771da8dd        2 hours ago         456MB</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also use the script <code>buildImage.sh</code> that will build source and create the container image
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-deploy-configuration"><a class="anchor" href="#crtd-deploy-configuration"></a>Deploy Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In previous chapter we saw how we can deploy service using holistic service resource file, in this chapter we will see how to deploy the service using configurations and resource files.</p>
</div>
<div class="paragraph">
<p>Navigate to folder <code>$TUTORIAL_HOME/02-configs-and-routes</code>:</p>
</div>
<div class="sect2">
<h3 id="_deploy_configuration_revision_1"><a class="anchor" href="#_deploy_configuration_revision_1"></a>Deploy Configuration revision 1</h3>
<div class="paragraph">
<p>The following snippet how a Knative configuration resource YAML will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Configuration
metadata:
  name: greeter
spec:
  revisionTemplate:
    metadata:
      labels:
        app: greeter
    spec:
      container:
        image: dev.local/rhdevelopers/greeter:0.0.1 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>configuration-rev1.yaml</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It is very important that the image is a fully qualified name docker image name with tag. For more details on this <a href="#faq-q2">Question 2 of FAQ</a></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The service could be deployed using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f config/configuration-rev1.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f config/configuration-rev1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>After successful deployment of the service we should see a kubernetes deployment called <code>greeter-00001-deployment</code> available.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/greeter-00001.png" alt="Greeter Service">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-invoke-service"><a class="anchor" href="#crtd-invoke-service"></a>Invoke Service</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">INGRESSGATEWAY=istio-ingressgateway
IP_ADDRESS="$(minishift ip):$(kubectl get svc $INGRESSGATEWAY --namespace istio-system --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -H "Host: greeter.knativetutorial.example.com" $IP_ADDRESS</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">http $IP_ADDRESS 'Host: greeter.knativetutorial.example.com'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command will return HTTP 404 as there are no routes deployed yet. Let us now deploy a route</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-deploy-route"><a class="anchor" href="#crtd-deploy-route"></a>Deploy Route</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let us now deploy a default route that will route all the traffic to  service deployed via configuration <code>greeter</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Route
metadata:
  name: greeter
spec:
  traffic:
    - configurationName: greeter
      percent: 100</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>route_default.yaml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f route/route_default.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f route/route_default.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#invoke-service">Invoking Service</a> now should return a response like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 1</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Sometimes the response might not be returned immediately especially when the pod is coming up from dormant state, at those times try giving request again
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-see-what-you-have-deployed"><a class="anchor" href="#crtd-see-what-you-have-deployed"></a>See what you have deployed</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The holistic service base deployment strategy that we did now will create the following resource objects:</p>
</div>
<div class="sect2">
<h3 id="crtd-show-knative-services"><a class="anchor" href="#crtd-show-knative-services"></a>service</h3>
<div id="knative-services" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># get a Knative Service (short name ksvc) called greeter
oc -n knativetutorial  get services.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial  get services.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command will throw an error as there are no knative services deployed as part of configuration+routes based deployment strategy.</p>
</div>
</div>
<div class="sect2">
<h3 id="crtd-show-knative-configs"><a class="anchor" href="#crtd-show-knative-configs"></a>configuration</h3>
<div id="knative-configs" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># get a Knative configuration called greeter
oc -n knativetutorial get configurations.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial get configurations.serving.knative.dev greeter</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="crtd-show-knative-routes"><a class="anchor" href="#crtd-show-knative-routes"></a>routes</h3>
<div id="knative-routes" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># get a Knative routes called greeter
oc -n knativetutorial get routes.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial get routes.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the service was invoked with <code>curl -H "Host: greeter.knativetutorial.example.com" $IP_ADDRESS</code>,  you noticed that we added a <strong>Host</strong> header to the curl with value <code>greeter.knativetutorial.example.com</code>, this FQDN is automatically assigned to your Knative service by the Knative Routes.   It follows a format <code>&lt;service-name&gt;.&lt;namespace&gt;.&lt;domain-suffix&gt;</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>The domain suffix in this case <em>example.com</em> is configurable via the config map <strong>config-domain</strong> of <strong>knative-serving</strong> namespace.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="crtd-show-knative-revisions"><a class="anchor" href="#crtd-show-knative-revisions"></a>revisions</h3>
<div id="knative-revisions" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># get a Knative revisions called greeter you will see only one like greeter-00001
oc -n knativetutorial get revisions.serving.knative.dev</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial get revisions.serving.knative.dev</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>add <code>-oyaml</code> to the commands above to see more details</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-deploying-new-revision"><a class="anchor" href="#crtd-deploying-new-revision"></a>Deploy new Revision Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the new revision of the service we will add an environment variable to the service deployment. As Knative follows 12-Factor application principles, any new configuration change will trigger new deployment, in this case it is the new environment variable.</p>
</div>
<div class="sect2">
<h3 id="_deploy_configuration_revision_2"><a class="anchor" href="#_deploy_configuration_revision_2"></a>Deploy configuration revision 2</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Configuration
metadata:
  name: greeter
spec:
  revisionTemplate:
    metadata:
      labels:
        app: greeter
    spec:
      container:
        image: dev.local/rhdevelopers/greeter:0.0.1
        env: <i class="conum" data-value="1"></i><b>(1)</b>
          - name: MESSAGE_PREFIX
            value: Hello</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>configuration-rev2.yaml</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adding an environment variable that will be used a message prefix</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let us deploy the new revision using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f config/configuration-rev2.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f config/configuration-rev2.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>After successful deployment of the service we should see a kubernetes deployment called <code>greeter-00002-deployment</code> available in the OpenShift dashboard:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/greeter-00002.png" alt="Greeter Service rev2">
</div>
</div>
<div class="paragraph">
<p>Now running the <a href="#show-knative-revisions">command</a> will show two revisions namely <code>greeter-00001</code> and <code>greeter-0002</code>.</p>
</div>
<div class="paragraph">
<p><a href="#invoke-service">Invoking Service</a> will now show an output like <strong>Hello greeter &#8658; greeter-00002-deployment-8d9984dc8-rgzx6: 2</strong>, where <em>Hello</em> is the value that we configured via environment variable in the Knative service resource file.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crtd-distributing-traffic"><a class="anchor" href="#crtd-distributing-traffic"></a>Distributing traffic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When deploying services with service object based approach, the service deployment will take care of traffic distribution either 100% to latest or pinned revision.  In this section we will explore how we can deploy routes to distribute traffic between deployed revisions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For the sake of clarity we will call greeter-00001 as <strong>revision 1</strong> and greeter-00002 as <strong>revision 2</strong></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before we start to apply routes, let us open a new terminal and run the following command <code>$TUTORIAL_HOME/02-configs-and-routes/bin/call.sh</code>, this command will keep sending requests to greeter service in every two seconds which allows us to monitor the changes to responses as we keep applying the route that will distribute the traffic between available two revisions.</p>
</div>
<div class="sect2">
<h3 id="crtd-all-rev1"><a class="anchor" href="#crtd-all-rev1"></a>All traffic to revision 1</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f route/route_all_rev1.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f route/route_all_rev1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice the output on your other terminal to be something like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 34</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="crtd-all-rev2"><a class="anchor" href="#crtd-all-rev2"></a>All traffic to revision 2</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f route/route_all_rev2.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f route/route_all_rev2.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice the output on your other terminal to be something like <strong>Hello greeter &#8658; greeter-00002-deployment-8d9984dc8-rgzx6: 13</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="crtd-all-rev1-rev2-50"><a class="anchor" href="#crtd-all-rev1-rev2-50"></a>50-50 between revision 1 and revision 2</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f route/route_rev1-50_rev2-50.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f route/route_rev1-50_rev2-50.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice the output will be mix of responses like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 11</strong> and <strong>Hello greeter &#8658; greeter-00002-deployment-8d9984dc8-rgzx6: 10</strong> approximately distributed 50% between each.</p>
</div>
</div>
<div class="sect2">
<h3 id="crtd-all-rev1-rev2-75-25"><a class="anchor" href="#crtd-all-rev1-rev2-75-25"></a>75-25 between revision 1 and revision 2</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f route/route_rev1-75_rev2-25.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f route/route_rev1-75_rev2-25.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice the output will be mix of responses like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 6</strong> and <strong>Hello greeter &#8658; greeter-00002-deployment-8d9984dc8-rgzx6: 7</strong>, with more requests responded by revision  1 approximately distributed 75% to 25 % between revision 1 and revision 2.</p>
</div>
</div>
<div class="sect2">
<h3 id="crtd-all-rev1-rev2-10-90"><a class="anchor" href="#crtd-all-rev1-rev2-10-90"></a>10-90 between revision 1 and revision 2</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -n knativetutorial -f route/route_rev1-10_rev2-90.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f route/route_rev1-10_rev2-90.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice the will be mix of responses like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 4</strong> and <strong>Hello greeter &#8658; greeter-00002-deployment-8d9984dc8-rgzx6: 5</strong>, with more requests responded by revision 2 approximately 10% to 90% between revision 1 and revision 2.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In response texts e.g <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 4</strong> the numbers at the end of the responses shows a count of now may requests has been handled by the service in this example  it is <em>4</em>.  Also note that the output count number may vary according to number of requests that you might have issued.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ctrd-cleanup"><a class="anchor" href="#ctrd-cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc -n knativetutorial delete configurations.serving.knative.dev greeter
oc -n knativetutorial delete routes.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial delete configurations.serving.knative.dev greeter
kubectl -n knativetutorial delete routes.serving.knative.dev greeter</code></pre>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
