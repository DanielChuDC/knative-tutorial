<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<meta name="author" content="Red Hat Developer Experience Team">
<title>Knative Tutorial</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.js"></script>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Knative Tutorial</h1>
<div class="details">
<span id="author" class="author">Red Hat Developer Experience Team</span><br>
<span id="revnumber">version 0.0.1</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#overview">Overview</a></li>
<li><a href="#setup">Setup</a>
<ul class="sectlevel2">
<li><a href="#prerequisite">Prerequisite CLI tools</a></li>
<li><a href="#download-tutorial-sources">Download Tutorial Sources</a></li>
<li><a href="#minishift">Minishift</a></li>
<li><a href="#admission-controller-webhook">Enable Admission Controller Webhook</a></li>
<li><a href="#setup-knative">Knative Setup</a></li>
<li><a href="#configure-openshift-project">Configuring OpenShift project for Knative applications</a></li>
</ul>
</li>
<li><a href="#basics-and-fundamentals">Basics and Fundamentals</a>
<ul class="sectlevel2">
<li><a href="#basics-prerequisite">Prerequisite</a></li>
<li><a href="#basics-build-containers">Build Containers</a></li>
<li><a href="#basics-deploy-service">Deploy Service</a></li>
<li><a href="#basics-invoke-service">Invoke Service</a></li>
<li><a href="#basics-see-what-you-have-deployed">See what you have deployed</a></li>
<li><a href="#deploying-new-revision">Deploy new Revision Service</a></li>
<li><a href="#basics-pinning-revision">Pinning service to a revision</a></li>
<li><a href="#basics-cleanup">Cleanup</a></li>
</ul>
</li>
<li><a href="#configurations-routes-and-traffic-distribution">Configurations, Routes and Traffic distribution</a>
<ul class="sectlevel2">
<li><a href="#crtd-prerequisite">Prerequisite</a></li>
<li><a href="#build">Build</a></li>
<li><a href="#crtd-deploy-configuration">Deploy Configuration</a></li>
<li><a href="#crtd-invoke-service">Invoke Service</a></li>
<li><a href="#crtd-deploy-route">Deploy Route</a></li>
<li><a href="#crtd-see-what-you-have-deployed">See what you have deployed</a></li>
<li><a href="#crtd-deploying-new-revision">Deploy new Revision Service</a></li>
<li><a href="#crtd-distributing-traffic">Distributing traffic</a></li>
<li><a href="#ctrd-cleanup">Cleanup</a></li>
</ul>
</li>
<li><a href="#scaling">Scaling</a>
<ul class="sectlevel2">
<li><a href="#scaling-prerequisite">Prerequisite</a></li>
<li><a href="#scaling-containers">Build Containers</a></li>
<li><a href="#scaling-deploy-service">Deploy Service</a></li>
<li><a href="#scaling-invoke-service">Invoke Service</a></li>
<li><a href="#scaling-auto-scaling">Auto Scaling</a></li>
<li><a href="#scaling-min-scale">Minimum Scale</a></li>
<li><a href="#scaling-cleanup">Cleanup</a></li>
</ul>
</li>
<li><a href="#faqs">FAQs</a>
<ul class="sectlevel2">
<li><a href="#faq-q1">How to access the Knative services ?</a></li>
<li><a href="#faq-q2">Why <code>dev.local</code> suffixes for container images?</a></li>
<li><a href="#faq-q3">What is revision simpler terms?</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Serverless epitomize the very benefits of what cloud platforms promise: offload the management of infrastructure while taking advantage of a consumption model for the actual utilization of services. While there are a number of server frameworks out there, Knative is the first serverless platform specifically designed for Kubernetes and OpenShift.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Serverless computing refers to the concept of building and running applications that do not require server management. It describes a finer-grained deployment model where applications, bundled as one or more functions, are uploaded to a platform and then executed, scaled, and billed in response to the exact demand needed at the moment”</p>
</div>
</blockquote>
</div>
<div class="paragraph text-right">
<p><em><strong>Source</strong></em>:  <a href="https://www.cncf.io/blog/2018/02/14/cncf-takes-first-step-towards-serverless-computing/" class="bare">https://www.cncf.io/blog/2018/02/14/cncf-takes-first-step-towards-serverless-computing/</a></p>
</div>
<div class="paragraph">
<p>This tutorial will act as step-by-step guide in helping you to understand Knative starting with setup, understanding fundamentals concepts such as service, configuration, revision etc., and finally deploying some use cases which could help deploying serverless applications at enterprises.</p>
</div>
<div class="paragraph">
<p>This content is brought to you by <a href="http://developers.redhat.com">Red Hat Developer Program</a> - Register today!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setup"><a class="anchor" href="#setup"></a>Setup</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="prerequisite"><a class="anchor" href="#prerequisite"></a>Prerequisite CLI tools</h3>
<div class="paragraph">
<p>You will need in this tutorial:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>Tool</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>macOS</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>Fedora</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>minishift</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://github.com/minishift/minishift/releases" class="bare">https://github.com/minishift/minishift/releases</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://github.com/minishift/minishift/releases" class="bare">https://github.com/minishift/minishift/releases</a></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">docker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://www.docker.com/docker-mac">Docker for Mac</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>dnf install docker</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl">kubectl</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-binary-via-curl">Mac OS</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>dnf install kubernetes-client</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://maven.apacge.org">Apache Maven</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>brew install maven</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>dnf install maven</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://github.com/wercker/stern">stern</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>brew install stern</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>sudo curl --output /usr/local/bin/stern -L <a href="https://github.com/wercker/stern/releases/download/1.6.0/stern_linux_amd64" class="bare">https://github.com/wercker/stern/releases/download/1.6.0/stern_linux_amd64</a> &amp;&amp; sudo chmod +x /usr/local/bin/stern</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>curl</code>, <code>gunzip</code>, <code>tar</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">built-in or part of your bash shell</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">should also be installed already, but just in case&#8230;&#8203; <code>dnf install curl gzip tar</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">git</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>brew install git</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>dnf install git</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="http://xmlstar.sourceforge.net/">xmlstarlet</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>brew install xmlstarlet</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="http://xmlstar.sourceforge.net/" class="bare">http://xmlstar.sourceforge.net/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://github.com/mikefarah/yq">yq</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>brew install yq</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://github.com/mikefarah/yq/releases/latest" class="bare">https://github.com/mikefarah/yq/releases/latest</a></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://httpie.org/">httpie</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>brew install httpie</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>dnf install httpie</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://golang.org">go</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>brew install golang</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://dl.google.com/go/go1.11.5.linux-amd64.tar.gz" class="bare">https://dl.google.com/go/go1.11.5.linux-amd64.tar.gz</a></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://github.com/rakyll/hey">hey</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>go get -u github.com/rakyll/hey</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>go get -u github.com/rakyll/hey</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="download-tutorial-sources"><a class="anchor" href="#download-tutorial-sources"></a>Download Tutorial Sources</h3>
<div class="paragraph">
<p>Before we start to setting up the environment, lets clone the tutorial sources and call the cloned folder as <code>$TUTORIAL_HOME</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">git clone https://github.com/kameshsampath/knative-tutorial</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All examples in this tutorial are tested with <strong>OpenShift 3.11</strong> and <strong>Knative 0.3.0</strong></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="minishift"><a class="anchor" href="#minishift"></a>Minishift</h3>
<div class="paragraph">
<p>All the demos in this tutorial will be run using <a href="https://github.com/minishift/minishift">minishift</a>, the single node <a href="https://www.okd.io/">OKD</a>(the Origin Community Distribution of Kubernetes that powers Red Hat OpenShift) cluster that can be used for development purposes.</p>
</div>
<div class="sect3">
<h4 id="setup-minishift"><a class="anchor" href="#setup-minishift"></a>Setup minishift</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">export TIMEZONE=$(sudo systemsetup -gettimezone | awk '{print $3}') <i class="conum" data-value="1"></i><b>(1)</b>
minishift profile set knative-tutorial
minishift config set openshift-version v3.11.0
minishift config set memory 8GB # if you more then preferred is 10GB
minishift config set cpus 4
minishift config set disk-size 50g
minishift config set image-caching true
minishift addons enable admin-user

minishift start --timezone $TIMEZONE

eval $(minishift docker-env) &amp;&amp; eval $(minishift oc-env)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Some examples we use in this tutorial are time sensitive, hence its recommended to set the appropriate timezone. If you are linux please use the appropriate command to get the timezone of the host.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="admission-controller-webhook"><a class="anchor" href="#admission-controller-webhook"></a>Enable Admission Controller Webhook</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#!/bin/bash

minishift openshift config set --target=kube --patch '{
  &quot;admissionConfig&quot;: {
    &quot;pluginConfig&quot;: {
      &quot;ValidatingAdmissionWebhook&quot;: {
        &quot;configuration&quot;: {
          &quot;apiVersion&quot;: &quot;apiserver.config.k8s.io/v1alpha1&quot;,
          &quot;kind&quot;: &quot;WebhookAdmission&quot;,
          &quot;kubeConfigFile&quot;: &quot;/dev/null&quot;
        }
      },
      &quot;MutatingAdmissionWebhook&quot;: {
        &quot;configuration&quot;: {
          &quot;apiVersion&quot;: &quot;apiserver.config.k8s.io/v1alpha1&quot;,
          &quot;kind&quot;: &quot;WebhookAdmission&quot;,
          &quot;kubeConfigFile&quot;: &quot;/dev/null&quot;
        }
      }
    }
  }
}'

# Allowing few minutes for the OpenShift to be restarted
until oc login -u admin -p admin 2&gt;/dev/null; do sleep 5; done;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setup-knative"><a class="anchor" href="#setup-knative"></a>Knative Setup</h3>
<div class="sect3">
<h4 id="login-as-admin"><a class="anchor" href="#login-as-admin"></a>Login as admin user</h4>
<div class="paragraph">
<p>Since there was an <code>admin</code> addon added during minishift configuration, its now possible to login with the <code>admin</code> user. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc login -u admin -p admin</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="install-istio"><a class="anchor" href="#install-istio"></a>Install Istio</h4>
<div class="sect4">
<h5 id="istio-policies"><a class="anchor" href="#istio-policies"></a>Configure Istio Policies</h5>
<div class="paragraph">
<p>Knative depends on Istio, to deploy Istio you need to run the following commands to configure necessary <a href="https://istio.io/docs/setup/kubernetes/platform-setup/openshift/">privileges</a> to the service accounts used by Istio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc adm policy add-scc-to-user anyuid -z istio-ingress-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z default -n istio-system
oc adm policy add-scc-to-user anyuid -z prometheus -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-egressgateway-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-citadel-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-ingressgateway-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-cleanup-old-ca-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-mixer-post-install-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-mixer-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-pilot-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-sidecar-injector-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z cluster-local-gateway-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-galley-service-account -n istio-system</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="deploy-istio"><a class="anchor" href="#deploy-istio"></a>Deploy Istio Components</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -L https://github.com/knative/serving/releases/download/v0.3.0/istio.yaml \
  | sed 's/LoadBalancer/NodePort/' \
  | kubectl apply --filename -</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The above command throws some warnings and error as to some objects not found, it can safely ignore or run the command again
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can moinitor the Istio components via the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl get pods -n istio-system -w</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It will take a few minutes for all the Istio components to be up and running. Please wait for all the Istio pods to be running before deploying <a href="#install-knative-serving">Knative Serving</a>.  Use <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span> to exit watch mode.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="update-istio-sidecar-injector-configmap"><a class="anchor" href="#update-istio-sidecar-injector-configmap"></a>Update Istio sidecar injector ConfigMap</h5>
<div class="paragraph">
<p>The Istio v1.0.1 release automatic sidecar injection has removed <code>privileged:true</code> from init contianers,this will cause the Pods with istio proxies automatic inject to crash. Run the following command to update the <strong>istio-sidecar-injector</strong> ConfigMap.</p>
</div>
<div class="paragraph">
<p>The following command ensures that the <code>privileged:true</code> is added to the <strong>istio-sidecar-injector</strong> ConfigMap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n istio-system -f $TUTORIAL_HOME/patches/istio-sidecar-injector.yaml</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Run the above command only once per minishift instance
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="install-knative-build"><a class="anchor" href="#install-knative-build"></a>Install Knative Build</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Setup Knative Build Policies
oc adm policy add-scc-to-user anyuid -z build-controller -n knative-build

# Install Knative Build components
kubectl apply --filename https://github.com/knative/build/releases/download/v0.3.0/release.yaml

# give cluster admin privileges to Service Account Build Controller on project knative-build
oc adm policy add-cluster-role-to-user cluster-admin -z build-controller -n knative-build</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc get pods -n knative-build -w</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It will take a few minutes for all the Knative Build components to be up and running. Use <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span> to exit watch mode.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="install-knative-serving"><a class="anchor" href="#install-knative-serving"></a>Install Knative Serving</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Setup Knative Serving Policies
oc adm policy add-scc-to-user anyuid -z controller -n knative-serving
oc adm policy add-scc-to-user anyuid -z autoscaler -n knative-serving

# Install Knative Serving components
curl -L https://github.com/knative/serving/releases/download/v0.3.0/serving.yaml \
  | sed 's/LoadBalancer/NodePort/' \
  | kubectl apply --filename -

# give cluster admin privileges to Service Account Controller on project knative-serving
oc adm policy add-cluster-role-to-user cluster-admin -z controller -n knative-serving</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can monitor the Knative Serving components via  components via the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc get pods -n knative-serving -w</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It will take a few minutes for all the Knative Serving components to be up and running. Use <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span> to exit watch mode.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="install-knative-eventing"><a class="anchor" href="#install-knative-eventing"></a>Install Knative Eventing</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Setup Knative Eventing Policies
oc adm policy add-scc-to-user anyuid -z eventing-controller -n knative-eventing
oc adm policy add-scc-to-user anyuid -z in-memory-channel-dispatcher -n knative-eventing
oc adm policy add-scc-to-user anyuid -z in-memory-channel-controller -n knative-eventing

# Install Knative Eventing components
kubectl apply --filename https://github.com/knative/eventing/releases/download/v0.3.0/release.yaml
kubectl apply --filename https://github.com/knative/eventing-sources/releases/download/v0.3.0/release.yaml

# give cluster admin privileges to Service Accounts on project knative-eventing
oc adm policy add-cluster-role-to-user cluster-admin -z eventing-controller -n knative-eventing
oc adm policy add-cluster-role-to-user cluster-admin -z default -n knative-sources
oc adm policy add-cluster-role-to-user cluster-admin -z in-memory-channel-dispatcher -n knative-eventing
oc adm policy add-cluster-role-to-user cluster-admin -z in-memory-channel-controller -n knative-eventing</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can monitor the Knative Eventing components via  components via the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc get pods -n knative-eventing -w</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It will take a few minutes for all the Knative Eventing components to be up and running. Use <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span> to exit watch mode.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configure-openshift-project"><a class="anchor" href="#configure-openshift-project"></a>Configuring OpenShift project for Knative applications</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc new-project knativetutorial
oc adm policy add-scc-to-user privileged -z default <i class="conum" data-value="1"></i><b>(1)</b>
oc adm policy add-scc-to-user anyuid -z default</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>oc adm policy</code> adds the <strong>privileged</strong> <a href="https://docs.okd.io/3.10/admin_guide/manage_scc.html">Security Context Constraints(SCCs)</a>to the <strong>default</strong> Service Account. The SCCs are the precursor to the PSP (Pod Security Policy) mechanism in Kubernetes.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="basics-and-fundamentals"><a class="anchor" href="#basics-and-fundamentals"></a>Basics and Fundamentals</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to understand and know how to :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploy first Knative service ?</p>
</li>
<li>
<p>Deploying multiple revisions of the service</p>
</li>
<li>
<p>What different service deployment strategies possible (service vs configurations/routes) ?</p>
</li>
<li>
<p>Always running latest vs pinning revision to services</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="basics-prerequisite"><a class="anchor" href="#basics-prerequisite"></a>Prerequisite</h3>
<div class="paragraph">
<p>Ensure all CLI tools are in path and accessible</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># to make sure we are connected to minishift docker daemon and using right openshift client
eval $(minishift docker-env) &amp;&amp; eval $(minishift oc-env)
# right kubernetes and openshift versions
# oc v3.11.0+0cbc58b kubernetes v1.11.0+d4cacc0
oc version
# right maven version Apache Maven 3.5.4
./mvnw --version</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="basics-build-containers"><a class="anchor" href="#basics-build-containers"></a>Build Containers</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd $TUTORIAL_HOME/01-basics/java
./mvnw clean package
docker build -t dev.local/rhdevelopers/greeter:0.0.1 .

# check if images are built and available
# dev.local/rhdevelopers/greeter   0.0.1               6aa8771da8dd        2 hours ago         456MB
docker images | grep dev.local</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also use the script <code>buildImage.sh</code> that will build source and create the container image
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basics-deploy-service"><a class="anchor" href="#basics-deploy-service"></a>Deploy Service</h3>
<div class="paragraph">
<p>Navigate to folder <code>$TUTORIAL_HOME/01-basics/knative</code>.</p>
</div>
<div class="paragraph">
<p>The following snippet shows how a Knative service YAML will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre><span class="key">apiVersion</span>: <span class="string"><span class="content">serving.knative.dev/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">greeter</span></span>
<span class="key">spec</span>:
  <span class="key">runLatest</span>: <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">configuration</span>:
      <span class="key">revisionTemplate</span>:
        <span class="key">spec</span>:
          <span class="key">container</span>:
            <span class="key">image</span>: <span class="string"><span class="content">dev.local/rhdevelopers/greeter:0.0.1 </span></span><i class="conum" data-value="2"></i><b>(2)</b></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>service.yaml</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Makes Knative to always run the latest revision of the deployment</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is very important that the image is a fully qualified name docker image name with tag. For more details on this <a href="#faq-q2">Question 2 of FAQ</a></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The service could be deployed using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f service.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f service.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>After successful deployment of the service we should see a Kubernetes deployment called <code>greeter-00001-deployment</code> available in the OpenShift dashboard:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="images/greeter-00001.png" alt="Greeter Service">
</div>
</div>
</div>
<div class="sect2">
<h3 id="basics-invoke-service"><a class="anchor" href="#basics-invoke-service"></a>Invoke Service</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">INGRESSGATEWAY=istio-ingressgateway
IP_ADDRESS=&quot;$(minishift ip):$(kubectl get svc $INGRESSGATEWAY --namespace istio-system --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')&quot;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Host: greeter.knativetutorial.example.com&quot; $IP_ADDRESS</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">http $IP_ADDRESS 'Host: greeter.knativetutorial.example.com'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last curl command should return a response like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 1</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Sometimes the response might not be returned immediately especially when the pod is coming up from dormant state, at those times try giving request again
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basics-see-what-you-have-deployed"><a class="anchor" href="#basics-see-what-you-have-deployed"></a>See what you have deployed</h3>
<div class="paragraph">
<p>The service based deployment strategy that we did now will create many knative resources, the following commands will help you to query and find what has been deployed.</p>
</div>
<div class="sect3">
<h4 id="basics-show-knative-services"><a class="anchor" href="#basics-show-knative-services"></a>service</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># get a Knative Service (short name ksvc) called greeter
oc -n knativetutorial  get services.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knativetutorial  get services.serving.knative.dev greeter</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basics-show-knative-configs"><a class="anchor" href="#basics-show-knative-configs"></a>configuration</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># get a Knative configuration called greeter
oc -n knativetutorial get configurations.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knativetutorial get configurations.serving.knative.dev greeter</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basics-show-knative-routes"><a class="anchor" href="#basics-show-knative-routes"></a>routes</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># get a Knative routes called greeter
oc -n knativetutorial get routes.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knativetutorial get routes.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the service was invoked with <code>curl -H "Host: greeter.knativetutorial.example.com" $IP_ADDRESS</code>,you noticed that we added a <strong>Host</strong> header to the request with value <code>greeter.knativetutorial.example.com</code>,this FQDN is automatically assigned to your Knative service by the Knative Routes,it uses the format like <code><strong>&lt;service-name&gt;.&lt;namespace&gt;.&lt;domain-suffix&gt;</strong></code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>The domain suffix in this case <em>example.com</em> is configurable via the config map <strong>config-domain</strong> of <strong>knative-serving</strong> namespace.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="basics-show-knative-revisions"><a class="anchor" href="#basics-show-knative-revisions"></a>revisions</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># get a Knative revisions called greeter you will see only one like greeter-00001
oc -n knativetutorial get revisions.serving.knative.dev</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knativetutorial get revisions.serving.knative.dev</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>add <code>-oyaml</code> to the commands above to see more details</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploying-new-revision"><a class="anchor" href="#deploying-new-revision"></a>Deploy new Revision Service</h3>
<div class="paragraph">
<p>As Knative follows <a href="https://12factor.net">12-Factor</a> application principles, any new <a href="https://12factor.net/config">configuration</a> change will trigger new revision of the deployment.</p>
</div>
<div class="paragraph">
<p>To deploy a new revision of the greeter service, we will add an environment variable to the existing service as shown below:</p>
</div>
<div class="sect3">
<h4 id="basics-service-rev2"><a class="anchor" href="#basics-service-rev2"></a>Service revision 2</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre><span class="key">apiVersion</span>: <span class="string"><span class="content">serving.knative.dev/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">greeter</span></span>
<span class="key">spec</span>:
  <span class="key">runLatest</span>:
    <span class="key">configuration</span>:
      <span class="key">revisionTemplate</span>:
        <span class="key">spec</span>:
          <span class="key">container</span>:
            <span class="key">image</span>: <span class="string"><span class="content">dev.local/rhdevelopers/greeter:0.0.1</span></span>
            <span class="key">env</span>:
             - <span class="string"><span class="content">name: MESSAGE_PREFIX </span></span><i class="conum" data-value="1"></i><b>(1)</b>
               <span class="key">value</span>: <span class="string"><span class="content">Hello</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>service-env.yaml</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adding an environment variable that will be used a message prefix</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let us deploy the new revision using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f service-env.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f service-env.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>After successful deployment of the service we should see a Kubernetes deployment called <code>greeter-00002-deployment</code> available in the OpenShift dashboard:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/greeter-00002.png" alt="Greeter Service rev2">
</div>
</div>
<div class="paragraph">
<p>Now running the <a href="#show-knative-revisions">command</a> will show two revisions namely <code>greeter-00001</code> and <code>greeter-0002</code>.</p>
</div>
<div class="paragraph">
<p><a href="#invoke-service">Invoking Service</a> will now show an output like <strong>Hello greeter &#8658; greeter-00002-deployment-8d9984dc8-rgzx6: 2</strong>, where <em>Hello</em> is the value that we configured via environment variable in the Knative service resource file.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="basics-pinning-revision"><a class="anchor" href="#basics-pinning-revision"></a>Pinning service to a revision</h3>
<div class="paragraph">
<p>As you noticed that the Knative services always routes the traffic to the <strong>latest</strong> revision of the service deployment, thats because of the <strong>runLatest</strong> attribute in <a href="#service-rev2">service resource file</a>.</p>
</div>
<div class="paragraph">
<p>Let us now make the greeter service use earlier revision <code>greeter-00001</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can use the get <a href="#show-knative-revisions">[show-knative-revisions]</a> command to find the available revisions for the greeter service.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="service-pinned-to-revision-1"><a class="anchor" href="#service-pinned-to-revision-1"></a>Service pinned to revision 1</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre><span class="key">apiVersion</span>: <span class="string"><span class="content">serving.knative.dev/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">greeter</span></span>
<span class="key">spec</span>:
  <span class="key">pinned</span>: <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">revisionName</span>: <span class="string"><span class="content">greeter-00001</span></span>
  <span class="key">configuration</span>:
    <span class="key">revisionTemplate</span>:
      <span class="key">spec</span>:
        <span class="key">container</span>:
          <span class="key">image</span>: <span class="string"><span class="content">dev.local/rhdevelopers/greeter:0.0.1</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>service-pinned-rev1.yaml</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <strong>pinned</strong> attribute in service resource file will make Knative use the revision specified in the <strong>revisionName</strong> attribute.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let redeploy the greeter service to be pinned to revision <em>greeter-00001</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd $TUTORIAL_HOME/knative</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f service-pinned-rev1.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f service-pinned-rev1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#invoke-service">Invoking Service</a> will now show an output like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 3</strong>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="basics-cleanup"><a class="anchor" href="#basics-cleanup"></a>Cleanup</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc -n knativetutorial delete services.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knativetutorial delete services.serving.knative.dev greeter</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configurations-routes-and-traffic-distribution"><a class="anchor" href="#configurations-routes-and-traffic-distribution"></a>Configurations, Routes and Traffic distribution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to understand and know how to :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploying Knative configurations and routes separately</p>
</li>
<li>
<p>Distributing traffic between revisions of the service</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="crtd-prerequisite"><a class="anchor" href="#crtd-prerequisite"></a>Prerequisite</h3>
<div class="paragraph">
<p>Ensure all CLI tools are in path and accessible</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># to make sure we are connected to minishift docker daemon and using right openshift client
eval $(minishift docker-env) &amp;&amp; eval $(minishift oc-env)
# right kubernetes and openshift versions
# oc v3.11.0+0cbc58b kubernetes v1.11.0+d4cacc0
oc version
# right maven version Apache Maven 3.5.4
./mvnw --version</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="build"><a class="anchor" href="#build"></a>Build</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd $TUTORIAL_HOME/01-basics/java
./mvnw clean package
docker build -t dev.local/rhdevelopers/greeter:0.0.1 .

# check if images are built and available
# dev.local/rhdevelopers/greeter   0.0.1               6aa8771da8dd        2 hours ago         456MB
docker images | grep dev.local</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also use the script <code>buildImage.sh</code> that will build source and create the container image
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="crtd-deploy-configuration"><a class="anchor" href="#crtd-deploy-configuration"></a>Deploy Configuration</h3>
<div class="paragraph">
<p>In previous chapter we saw how we can deploy service using holistic service resource file, in this chapter we will see how to deploy the service using configurations and resource files.</p>
</div>
<div class="paragraph">
<p>Navigate to folder <code>$TUTORIAL_HOME/02-configs-and-routes</code>:</p>
</div>
<div class="sect3">
<h4 id="deploy-configuration-revision-1"><a class="anchor" href="#deploy-configuration-revision-1"></a>Deploy Configuration revision 1</h4>
<div class="paragraph">
<p>The following snippet how a Knative configuration resource YAML will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre><span class="key">apiVersion</span>: <span class="string"><span class="content">serving.knative.dev/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Configuration</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">greeter</span></span>
<span class="key">spec</span>:
  <span class="key">revisionTemplate</span>:
    <span class="key">metadata</span>:
      <span class="key">labels</span>:
        <span class="key">app</span>: <span class="string"><span class="content">greeter</span></span>
    <span class="key">spec</span>:
      <span class="key">container</span>:
        <span class="key">image</span>: <span class="string"><span class="content">dev.local/rhdevelopers/greeter:0.0.1 </span></span><i class="conum" data-value="1"></i><b>(1)</b></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>configuration-rev1.yaml</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It is very important that the image is a fully qualified name docker image name with tag. For more details on this <a href="#faq-q2">Question 2 of FAQ</a></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The service could be deployed using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f config/configuration-rev1.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f config/configuration-rev1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>After successful deployment of the service we should see a Kubernetes deployment called <code>greeter-00001-deployment</code> available in the OpenShift dashboard:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/greeter-00001.png" alt="Greeter Service">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="crtd-invoke-service"><a class="anchor" href="#crtd-invoke-service"></a>Invoke Service</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">INGRESSGATEWAY=istio-ingressgateway
IP_ADDRESS=&quot;$(minishift ip):$(kubectl get svc $INGRESSGATEWAY --namespace istio-system --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')&quot;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Host: greeter.knativetutorial.example.com&quot; $IP_ADDRESS</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">http $IP_ADDRESS 'Host: greeter.knativetutorial.example.com'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command will return HTTP 404 as there are no routes deployed yet. Let us now deploy a route</p>
</div>
</div>
<div class="sect2">
<h3 id="crtd-deploy-route"><a class="anchor" href="#crtd-deploy-route"></a>Deploy Route</h3>
<div class="paragraph">
<p>Let us now deploy a default route that will route all the traffic to  service deployed via configuration <code>greeter</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre><span class="key">apiVersion</span>: <span class="string"><span class="content">serving.knative.dev/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Route</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">greeter</span></span>
<span class="key">spec</span>:
  <span class="key">traffic</span>:
    - <span class="string"><span class="content">configurationName: greeter</span></span>
      <span class="key">percent</span>: <span class="string"><span class="content">100</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>route_default.yaml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f route/route_default.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f route/route_default.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#invoke-service">Invoking Service</a> now should return a response like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 1</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Sometimes the response might not be returned immediately especially when the pod is coming up from dormant state, at those times try giving request again
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="crtd-see-what-you-have-deployed"><a class="anchor" href="#crtd-see-what-you-have-deployed"></a>See what you have deployed</h3>
<div class="paragraph">
<p>The holistic service base deployment strategy that we did now will create the following resource objects:</p>
</div>
<div class="sect3">
<h4 id="crtd-show-knative-services"><a class="anchor" href="#crtd-show-knative-services"></a>service</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># get a Knative Service (short name ksvc) called greeter
oc -n knativetutorial  get services.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knativetutorial  get services.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command will throw an error as there are no knative services deployed as part of configuration+routes based deployment strategy.</p>
</div>
</div>
<div class="sect3">
<h4 id="crtd-show-knative-configs"><a class="anchor" href="#crtd-show-knative-configs"></a>configuration</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># get a Knative configuration called greeter
oc -n knativetutorial get configurations.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knativetutorial get configurations.serving.knative.dev greeter</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="crtd-show-knative-routes"><a class="anchor" href="#crtd-show-knative-routes"></a>routes</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># get a Knative routes called greeter
oc -n knativetutorial get routes.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knativetutorial get routes.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the service was invoked with <code>curl -H "Host: greeter.knativetutorial.example.com" $IP_ADDRESS</code>,  you noticed that we added a <strong>Host</strong> header to the curl with value <code>greeter.knativetutorial.example.com</code>, this FQDN is automatically assigned to your Knative service by the Knative Routes.   It follows a format <code>&lt;service-name&gt;.&lt;namespace&gt;.&lt;domain-suffix&gt;</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>The domain suffix in this case <em>example.com</em> is configurable via the config map <strong>config-domain</strong> of <strong>knative-serving</strong> namespace.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="crtd-show-knative-revisions"><a class="anchor" href="#crtd-show-knative-revisions"></a>revisions</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># get a Knative revisions called greeter you will see only one like greeter-00001
oc -n knativetutorial get revisions.serving.knative.dev</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knativetutorial get revisions.serving.knative.dev</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>add <code>-oyaml</code> to the commands above to see more details</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="crtd-deploying-new-revision"><a class="anchor" href="#crtd-deploying-new-revision"></a>Deploy new Revision Service</h3>
<div class="paragraph">
<p>For the new revision of the service we will add an environment variable to the service deployment. As Knative follows 12-Factor application principles, any new configuration change will trigger new deployment, in this case it is the new environment variable.</p>
</div>
<div class="sect3">
<h4 id="deploy-configuration-revision-2"><a class="anchor" href="#deploy-configuration-revision-2"></a>Deploy configuration revision 2</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span class="key">apiVersion</span>: <span class="string"><span class="content">serving.knative.dev/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Configuration</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">greeter</span></span>
<span class="key">spec</span>:
  <span class="key">revisionTemplate</span>:
    <span class="key">metadata</span>:
      <span class="key">labels</span>:
        <span class="key">app</span>: <span class="string"><span class="content">greeter</span></span>
    <span class="key">spec</span>:
      <span class="key">container</span>:
        <span class="key">image</span>: <span class="string"><span class="content">dev.local/rhdevelopers/greeter:0.0.1</span></span>
        <span class="key">env</span>: <i class="conum" data-value="1"></i><b>(1)</b>
          - <span class="string"><span class="content">name: MESSAGE_PREFIX</span></span>
            <span class="key">value</span>: <span class="string"><span class="content">Hello</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>configuration-rev2.yaml</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adding an environment variable that will be used a message prefix</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let us deploy the new revision using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f config/configuration-rev2.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f config/configuration-rev2.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>After successful deployment of the service we should see a Kubernetes deployment called <code>greeter-00002-deployment</code> available in the OpenShift dashboard:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/greeter-00002.png" alt="Greeter Service rev2">
</div>
</div>
<div class="paragraph">
<p>Now running the <a href="#show-knative-revisions">command</a> will show two revisions namely <code>greeter-00001</code> and <code>greeter-0002</code>.</p>
</div>
<div class="paragraph">
<p><a href="#invoke-service">Invoking Service</a> will now show an output like <strong>Hello greeter &#8658; greeter-00002-deployment-8d9984dc8-rgzx6: 2</strong>, where <em>Hello</em> is the value that we configured via environment variable in the Knative service resource file.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="crtd-distributing-traffic"><a class="anchor" href="#crtd-distributing-traffic"></a>Distributing traffic</h3>
<div class="paragraph">
<p>When deploying services with service object based approach, the service deployment will take care of traffic distribution either 100% to latest or pinned revision.  In this section we will explore how we can deploy routes to distribute traffic between deployed revisions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For the sake of clarity we will call greeter-00001 as <strong>revision 1</strong> and greeter-00002 as <strong>revision 2</strong></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before we start to apply routes, let us open a new terminal and run the following command <code>$TUTORIAL_HOME/02-configs-and-routes/bin/call.sh</code>, this command will keep sending requests to greeter service in every two seconds which allows us to monitor the changes to responses as we keep applying the route that will distribute the traffic between available two revisions.</p>
</div>
<div class="sect3">
<h4 id="crtd-all-rev1"><a class="anchor" href="#crtd-all-rev1"></a>All traffic to revision 1</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f route/route_all_rev1.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f route/route_all_rev1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice the output on your other terminal to be something like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 34</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="crtd-all-rev2"><a class="anchor" href="#crtd-all-rev2"></a>All traffic to revision 2</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f route/route_all_rev2.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f route/route_all_rev2.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice the output on your other terminal to be something like <strong>Hello greeter &#8658; greeter-00002-deployment-8d9984dc8-rgzx6: 13</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="crtd-all-rev1-rev2-50"><a class="anchor" href="#crtd-all-rev1-rev2-50"></a>50-50 between revision 1 and revision 2</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f route/route_rev1-50_rev2-50.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f route/route_rev1-50_rev2-50.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice the output will be mix of responses like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 11</strong> and <strong>Hello greeter &#8658; greeter-00002-deployment-8d9984dc8-rgzx6: 10</strong> approximately distributed 50% between each.</p>
</div>
</div>
<div class="sect3">
<h4 id="crtd-all-rev1-rev2-75-25"><a class="anchor" href="#crtd-all-rev1-rev2-75-25"></a>75-25 between revision 1 and revision 2</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f route/route_rev1-75_rev2-25.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f route/route_rev1-75_rev2-25.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice the output will be mix of responses like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 6</strong> and <strong>Hello greeter &#8658; greeter-00002-deployment-8d9984dc8-rgzx6: 7</strong>, with more requests responded by revision  1 approximately distributed 75% to 25 % between revision 1 and revision 2.</p>
</div>
</div>
<div class="sect3">
<h4 id="crtd-all-rev1-rev2-10-90"><a class="anchor" href="#crtd-all-rev1-rev2-10-90"></a>10-90 between revision 1 and revision 2</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f route/route_rev1-10_rev2-90.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f route/route_rev1-10_rev2-90.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice the will be mix of responses like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 4</strong> and <strong>Hello greeter &#8658; greeter-00002-deployment-8d9984dc8-rgzx6: 5</strong>, with more requests responded by revision 2 approximately 10% to 90% between revision 1 and revision 2.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In response texts e.g <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 4</strong> the numbers at the end of the responses shows a count of now may requests has been handled by the service in this example  it is <em>4</em>.  Also note that the output count number may vary according to number of requests that you might have issued.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ctrd-cleanup"><a class="anchor" href="#ctrd-cleanup"></a>Cleanup</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc -n knativetutorial delete configurations.serving.knative.dev greeter
oc -n knativetutorial delete routes.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knativetutorial delete configurations.serving.knative.dev greeter
kubectl -n knativetutorial delete routes.serving.knative.dev greeter</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling"><a class="anchor" href="#scaling"></a>Scaling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure the scale to zero time period</p>
</li>
<li>
<p>Configure auto scaling</p>
</li>
<li>
<p>Understanding types of autoscaling strategies</p>
</li>
<li>
<p>How to enable concurrency based auto scaling based concurrency</p>
</li>
<li>
<p>How to prevent minimum number of pods for a service i.e. no scale down to zero beyond this number of pods</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="scaling-prerequisite"><a class="anchor" href="#scaling-prerequisite"></a>Prerequisite</h3>
<div class="paragraph">
<p>Ensure all CLI tools are in path and accessible</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># to make sure we are connected to minishift docker daemon and using right openshift client
eval $(minishift docker-env) &amp;&amp; eval $(minishift oc-env)
# right kubernetes and openshift versions
# oc v3.11.0+0cbc58b kubernetes v1.11.0+d4cacc0
oc version
# right maven version Apache Maven 3.5.4
./mvnw --version</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scaling-containers"><a class="anchor" href="#scaling-containers"></a>Build Containers</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd $TUTORIAL_HOME/01-basics/java
./mvnw clean package
docker build -t dev.local/rhdevelopers/greeter:0.0.1 .

# check if images are built and available
# dev.local/rhdevelopers/greeter   0.0.1               6aa8771da8dd        2 hours ago         456MB
docker images | grep dev.local</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also use the script <code>buildImage.sh</code> that will build source and create the container image
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="scaling-deploy-service"><a class="anchor" href="#scaling-deploy-service"></a>Deploy Service</h3>
<div class="paragraph">
<p>The following snippet shows how a Knative service YAML will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre><span class="key">apiVersion</span>: <span class="string"><span class="content">serving.knative.dev/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">greeter</span></span>
<span class="key">spec</span>:
  <span class="key">runLatest</span>: <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">configuration</span>:
      <span class="key">revisionTemplate</span>:
        <span class="key">spec</span>:
          <span class="key">container</span>:
            <span class="key">image</span>: <span class="string"><span class="content">dev.local/rhdevelopers/greeter:0.0.1 </span></span><i class="conum" data-value="2"></i><b>(2)</b></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>service.yaml</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Makes Knative to always run the latest revision of the deployment</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is very important that the image is a fully qualified name docker image name with tag. For more details on this <a href="#faq-q2">Question 2 of FAQ</a></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The service could be deployed using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd $TUTORIAL_HOME/01-basics/knative</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f service.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f service.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>After successful deployment of the service we should see a Kubernetes deployment called <code>greeter-00001-deployment</code> available in the OpenShift dashboard:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/greeter-00001.png" alt="Greeter Service">
</div>
</div>
</div>
<div class="sect2">
<h3 id="scaling-invoke-service"><a class="anchor" href="#scaling-invoke-service"></a>Invoke Service</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">INGRESSGATEWAY=istio-ingressgateway
IP_ADDRESS=&quot;$(minishift ip):$(kubectl get svc $INGRESSGATEWAY --namespace istio-system --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')&quot;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Host: greeter.knativetutorial.example.com&quot; $IP_ADDRESS</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">http $IP_ADDRESS 'Host: greeter.knativetutorial.example.com'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last curl command should return a response like <strong>Hi greeter &#8658; greeter-00001-deployment-5d696cc6c8-m65s5: 1</strong></p>
</div>
<div class="paragraph">
<p>Check <a href="#basics-see-what-you-have-deployed">deployed Knative resources</a> tfor more details of what Knative objects and resources have been created with the above service deployment.</p>
</div>
<div class="sect3">
<h4 id="configure-scale-to-zero"><a class="anchor" href="#configure-scale-to-zero"></a>Configure scale to zero</h4>
<div class="paragraph">
<p>Assuming that <a href="#scaling-deploy-service">Greeter service</a> has been deployed, if the service has been terminated, the let us <a href="#scaling-invoke-service">invoke the service</a> to make service available for request.</p>
</div>
<div class="sect4">
<h5 id="scale-to-zero-formulae"><a class="anchor" href="#scale-to-zero-formulae"></a>Calculating scale to zero time period</h5>
<div class="paragraph">
<p>Knative autoscaler uses the config map <strong>config-autoscaler</strong> of <strong>knative-serving</strong> namespace for autoscaling related properties.  The value of the attribute <code>stable-window</code> and <code>scale-to-zero-grace-period</code> decides how long Knative autoscaler will wait before terminating the inactive revision pod.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">stableWindow=`oc -n knative-serving get configmaps config-autoscaler -o yaml |
 yq r - data.stable-window`
scaleToZeroGracePeriod=`oc -n knative-serving get configmaps config-autoscaler -o yaml |
 yq r - data.scale-to-zero-grace-period`</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">stableWindow=`kubectl -n knative-serving get configmaps config-autoscaler -o yaml |
 yq r - data.stable-window`
scaleToZeroGracePeriod=`kubectl -n knative-serving get configmaps config-autoscaler -o yaml |
 yq r - data.scale-to-zero-grace-period`</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><code>termination period time in seconds = stableWindow + scaleToZeroGracePeriod</code></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>scale-to-zero-grace-period is dynamic parameter i.e. the value is immediately effected after updating the config map</p>
</li>
<li>
<p>the minimum value that can be set for <code>scale-to-zero-grace-period</code> is 30 seconds</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="observing-default-scale-down"><a class="anchor" href="#observing-default-scale-down"></a>Observing default scale down</h4>
<div class="paragraph">
<p>You can open a new terminal and run the command <code>watch 'oc get pods -n knativetutorial'</code> to view the scale up and scale down to zero.</p>
</div>
<div class="paragraph">
<p>Checking default values</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># should return 60s
echo $stableWindow
# should return 30s
echo $scaleToZeroGracePeriod</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the <strong>scale-to-zero-grace-period</strong> is <code>30s</code>, and the <strong>stable-window</strong> is <code>60s</code>, firing the request to the greeter service will bring up the pod (if its already terminated) to serve the request. Leaving it without any further requests, it will automatically scale to zero <code>1 min 30 secs</code>(<a href="#scale-to-zero-formulae">Compute scale to zero grace period</a>)..</p>
</div>
</div>
<div class="sect3">
<h4 id="update-scale-down-to-1-minute"><a class="anchor" href="#update-scale-down-to-1-minute"></a>Update scale down to 1 minute</h4>
<div class="paragraph">
<p>Let us now update <strong>scale-to-zero-grace-period</strong> to <code>1m</code> and leave the <strong>stable-window</strong> to default <code>60s</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd $TUTORIAL_HOME/03-scaling/knative</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc -n knative-serving get cm config-autoscaler -o yaml | yq w - -s configure-scaling-to-1m.yaml | oc apply -f -</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knative-serving get cm config-autoscaler -o yaml | yq w - -s configure-scaling-to-1m.yaml | kubectl apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verifying the <code>scale-to-zero-grace-period</code> value, which should return <code>1m</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc -n knative-serving get configmap config-autoscaler -o yaml \
  | yq r - data.scale-to-zero-grace-period</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knative-serving get configmap config-autoscaler -o yaml \
 | yq r - data.scale-to-zero-grace-period</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now <a href="#scaling-invoke-service">firing the request</a> to the greeter service will bring up the pod to serve the request.Leaving it without any further requests, it will automatically scale to zero <code>2 mins</code>(<a href="#scale-to-zero-formulae">Compute scale to zero grace period</a>)</p>
</div>
</div>
<div class="sect3">
<h4 id="update-scale-down-to-2-minute"><a class="anchor" href="#update-scale-down-to-2-minute"></a>Update scale down to 2 minute</h4>
<div class="paragraph">
<p>Let us now update <strong>scale-to-zero-grace-period</strong> to <code>2m</code> and leave the <strong>stable-window</strong> to default <code>60s</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc -n knative-serving get cm config-autoscaler -o yaml | yq w - -s configure-scaling-to-2m.yaml | oc apply -f -</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knative-serving get cm config-autoscaler -o yaml | yq w - -s configure-scaling-to-2m.yaml | kubectl apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verifying the <code>scale-to-zero-grace-period</code> value, which should return <code>2m</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># should return 2m
oc -n knative-serving get configmap config-autoscaler -o yaml \
  | yq r - data.scale-to-zero-grace-period</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knative-serving get configmap config-autoscaler -o yaml \
 | yq r - data.scale-to-zero-grace-period</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now <a href="#scaling-invoke-service">firing the request</a> to the greeter service will bring up the pod to serve the request and if we leave the service without any further requests, it will automatically scale to zero in <code>3 mins</code>(<a href="#scale-to-zero-formulae">Compute scale to zero grace period</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="reset-to-defaults"><a class="anchor" href="#reset-to-defaults"></a>Reset to defaults</h4>
<div class="paragraph">
<p>Let us revert the <code>scale-to-zero-grace-period</code> to defaults:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc -n knative-serving get cm config-autoscaler -o yaml | yq w - -s configure-scaling-to-30s.yaml | oc apply -f -</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knative-serving get cm config-autoscaler -o yaml | yq w - -s configure-scaling-to-30s.yaml | kubectl apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verifying the <code>scale-to-zero-grace-period</code> value, which should return <code>30s</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># should return 2m
oc -n knative-serving get configmap config-autoscaler -o yaml \
  | yq r - data.scale-to-zero-grace-period</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knative-serving get configmap config-autoscaler -o yaml \
 | yq r - data.scale-to-zero-grace-period</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the sake of clarity and better understanding <a href="#scaling-cleanup">clean up</a> the deployed knative service before going to next section.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scaling-auto-scaling"><a class="anchor" href="#scaling-auto-scaling"></a>Auto Scaling</h3>
<div class="paragraph">
<p>By default Knative Serving allows 100 concurrency pods, you can view the setting <code>container-concurrency-target-default</code> in the configmap <strong>config-autoscaler </strong> of <strong>knative-serving</strong> namespace.</p>
</div>
<div class="paragraph">
<p>For this exercise let us make our service handle only <strong>10</strong> concurrent requests,this will make the Knative-Serving to scale the pods to handle the requests more than 10 requests</p>
</div>
<div class="sect3">
<h4 id="scaling-concurrency-10"><a class="anchor" href="#scaling-concurrency-10"></a>Service with concurrency of 10 requests</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span class="key">apiVersion</span>: <span class="string"><span class="content">serving.knative.dev/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">greeter</span></span>
<span class="key">spec</span>:
  <span class="key">runLatest</span>:
    <span class="key">configuration</span>:
      <span class="key">revisionTemplate</span>:
        <span class="key">metadata</span>:
          <span class="key">annotations</span>:
            <span class="key">autoscaling.knative.dev/target</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="key">spec</span>:
          <span class="key">container</span>:
            <span class="key">image</span>: <span class="string"><span class="content">dev.local/rhdevelopers/greeter:0.0.1</span></span>
            <span class="key">livenessProbe</span>:
              <span class="key">httpGet</span>:
                <span class="key">path</span>: <span class="string"><span class="content">/healthz</span></span>
            <span class="key">readinessProbe</span>:
              <span class="key">httpGet</span>:
                <span class="key">path</span>: <span class="string"><span class="content">/healthz</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>service-10.yaml</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Will allow each service pod to handle max of 10 in-flight requests per pod before automatically scaling to new pod(s)</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="scaling-deploy-service"><a class="anchor" href="#scaling-deploy-service"></a>Deploy service</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f service-10.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f service-10.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scaling-invoke-service"><a class="anchor" href="#scaling-invoke-service"></a>Invoke Service</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">INGRESSGATEWAY=istio-ingressgateway
IP_ADDRESS=&quot;$(minishift ip):$(kubectl get svc $INGRESSGATEWAY --namespace istio-system --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open a new terminal and run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">watch oc get pods -n knativetutorial</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">watch kubectl get pods -n knativetutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scaling-load-service"><a class="anchor" href="#scaling-load-service"></a>Load the service</h4>
<div class="paragraph">
<p>We will now send some load to the greeter service.  The command below sends 50 concurrent requests (<code>-c 50</code>) for next 10s (<code>-z 10s</code>) with no connection timeout(<code>-t 0</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">hey -z 10s -c 50 -t 0 \
  -host &quot;greeter.knativetutorial.example.com&quot; \
  &quot;http://${IP_ADDRESS}&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After successful run the load test, you will notice the number of greeter service pods would have automatically scaled to 5, you can also view the same via OpenShift dashboard as shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/greeter-00001-scaled.png" alt="Greeter Service">
</div>
</div>
<div class="paragraph">
<p>The autoscale pods is computed using the formula:</p>
</div>
<div class="listingblock text-center">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">totalPodsToScale = total number of inflight requests / average concurrency target</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this current setting of <strong>average concurrency target=10</strong>(<code>autoscaling.knative.dev/target: "10"</code>) and <strong>total number of inflight requests=50</strong> , you will see Knative automatically scales the greeter services to  <code><strong>50/10 = 5 pods</strong></code>.</p>
</div>
<div class="paragraph">
<p>For more clarity and understanding let us <a href="#scaling-cleanup">clean up</a> existing deployments  before proceeding to next section.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scaling-min-scale"><a class="anchor" href="#scaling-min-scale"></a>Minimum Scale</h3>
<div class="paragraph">
<p>At times you might need that you always need to have <code>n</code> number of pods running e.g. cases where you want to handle sudden spike in requests, with Knative auto scaling we can do that with via <code>minScale</code> annotation.</p>
</div>
<div class="sect3">
<h4 id="scaling-deploy-service-minscale"><a class="anchor" href="#scaling-deploy-service-minscale"></a>Deploy service</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
  <td class="code"><pre><span class="key">apiVersion</span>: <span class="string"><span class="content">serving.knative.dev/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">greeter</span></span>
<span class="key">spec</span>:
  <span class="key">runLatest</span>:
    <span class="key">configuration</span>:
      <span class="key">revisionTemplate</span>:
        <span class="key">metadata</span>:
          <span class="key">annotations</span>:
            <span class="key">autoscaling.knative.dev/target</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="key">autoscaling.knative.dev/minScale</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="key">spec</span>:
          <span class="key">container</span>:
            <span class="key">image</span>: <span class="string"><span class="content">dev.local/rhdevelopers/greeter:0.0.1</span></span>
            <span class="key">livenessProbe</span>:
              <span class="key">httpGet</span>:
                <span class="key">path</span>: <span class="string"><span class="content">/healthz</span></span>
            <span class="key">readinessProbe</span>:
              <span class="key">httpGet</span>:
                <span class="key">path</span>: <span class="string"><span class="content">/healthz</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>service-min-scale.yaml</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Will allow each service pod to handle max of 10 in-flight requests per pod before automatically scaling to new pod(s)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Every new deployment of this service will minimum have two pods</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc apply -n knativetutorial -f service-min-scale.yaml</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -n knativetutorial -f service-min-scale.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>After successful deployment of the service we should see a Kubernetes deployment called <code>greeter-00001-deployment</code> with <strong>two</strong> pods readily available.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/greeter-00001-minscale.png" alt="Greeter Service">
</div>
</div>
<div class="paragraph text-center">
<p><strong>OpenShift Dashboard Knative Tutorial project</strong></p>
</div>
<div class="paragraph">
<p>Open a new terminal and run the following command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">watch oc get pods -n knativetutorial</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">watch kubectl get pods -n knativetutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us <a href="#scaling-load-service">send some load to the service</a> to trigger autoscaling.</p>
</div>
<div class="paragraph">
<p>When all requests are done and if you are beyond the <code>scale-to-zero-grace-period</code>, you will notice that Knative has terminated only 3 out 5 pods, this is because we have configured Knative to always run two pods via the annotation <code>autoscaling.knative.dev/minScale: "2"</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scaling-cleanup"><a class="anchor" href="#scaling-cleanup"></a>Cleanup</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc -n knativetutorial delete services.serving.knative.dev greeter</code></pre>
</div>
</div>
<div class="paragraph text-center">
<p><strong>(OR)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl -n knativetutorial delete services.serving.knative.dev greeter</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="faqs"><a class="anchor" href="#faqs"></a>FAQs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="faq-q1"><a class="anchor" href="#faq-q1"></a>How to access the Knative services ?</h3>
<div class="paragraph">
<p>When looking up the IP address to use for accessing your app, you need to look up the NodePort for the <strong>istio-ingressgateway</strong> well as the IP address used for minishift. You can use the following command to look up the value to use for the {IP_ADDRESS} placeholder used in the sample</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#!/bin/bash
# In Knative 0.2.x and prior versions, the `knative-ingressgateway` service was used instead of `istio-ingressgateway`.
INGRESSGATEWAY=knative-ingressgateway

# The use of `knative-ingressgateway` is deprecated in Knative v0.3.x.
# Use `istio-ingressgateway` instead, since `knative-ingressgateway`
# will be removed in Knative v0.4.
if kubectl get configmap config-istio -n knative-serving &amp;&gt; /dev/null; then
    INGRESSGATEWAY=istio-ingressgateway
fi

INGRESSGATEWAY=istio-ingressgateway
IP_ADDRESS=&quot;$(minishift ip):$(kubectl get svc $INGRESSGATEWAY --namespace istio-system --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')&quot;

# calling a knative service named greeter
curl -H &quot;Host: greeter.myproject.example.com&quot; $IP_ADDRESS</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="faq-q2"><a class="anchor" href="#faq-q2"></a>Why <code>dev.local</code> suffixes for container images?</h3>
<hr>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Docker images wit v2 or later format has content addressable identifier called digest. The digest remains unchanged as long the underlying image content remains unchanged.</p>
</div>
</blockquote>
</div>
<div class="paragraph text-right">
<p><em><strong>Source</strong>: <a href="https://docs.docker.com/engine/reference/commandline/images/#list-image-digests" class="bare">https://docs.docker.com/engine/reference/commandline/images/#list-image-digests</a></em></p>
</div>
<hr>
<div class="paragraph">
<p>Let say you have a deployment like the following (note that resource definition have been trimmed for brevity):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre><span class="key">apiVersion</span>: <span class="string"><span class="content">apps/v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Deployment</span></span>
<span class="key">metadata</span>:
   <span class="key">name</span>: <span class="string"><span class="content">helloworld</span></span>
<span class="key">spec</span>:
  <span class="key">template</span>:
    <span class="key">spec</span>:
       <span class="key">containers</span>:
         - <span class="string"><span class="content">name: my-container</span></span>
           <span class="key">image</span>: <span class="string"><span class="content">gcr.io/knative-samples/helloworld-go</span></span>

<span class="error">. . .</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>When you deploy this application in Kubernetes, the deployment will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre><span class="key">apiVersion</span>: <span class="string"><span class="content">apps/v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Deployment</span></span>
<span class="key">metadata</span>:
   <span class="key">name</span>: <span class="string"><span class="content">helloworld</span></span>
<span class="key">spec</span>:
  <span class="key">template</span>:
    <span class="key">spec</span>:
       <span class="key">containers</span>:
          - <span class="string"><span class="content">name: my-container</span></span>
            <span class="key">image</span>: <span class="string"><span class="delimiter">&gt;-</span><span class="content">
                   gcr.io/knative-samples/helloworld-go@sha256:98af362ceca8191277206b3b3854220ce125924b28a1166126296982e33882d0</span></span>
<span class="error">. . .</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the container image name of the deployment  i.e. gcr.io/knative-samples/helloworld-go was resolved to its digest gcr.io/knative-samples/helloworld-go@sha256:98af362ceca8191277206b3b3854220ce125924b28a1166126296982e33882d0. Kubernetes extracts the digest from the image manifest.  This process of resolving  image tag to its digest is informally called as “Tag to Digest”.</p>
</div>
<div class="paragraph">
<p>Knative Serving deployments by default resolve the container images to digest during the deployment process. Knative Serving has been configured to skip the resolution of   image name/tag to image digest for registries ko.local and dev.local, which can be used for local development builds, as the underlying image content are subject to changes during the  development process.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can also add any of the other image repo suffixes from skipping to digest by editing the configmap <strong>config-controller</strong> of <strong>knative-serving</strong> namespace and appending your repo to <code>registriesSkippingTagResolving</code> attribute of the configmap.</p>
</div>
<div class="paragraph">
<p>The following command shows an example how to add a registry <strong>my.docker.registry</strong> to the be skipped:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>val=$(oc -n knative-serving get cm config-controller -oyaml | yq r - data.registriesSkippingTagResolving | awk '{print $1",my.docker.registry"}')

oc -n knative-serving get cm config-controller -oyaml | yq w - data.registriesSkippingTagResolving $val | oc apply -f -</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="faq-q3"><a class="anchor" href="#faq-q3"></a>What is revision simpler terms?</h3>
<div class="paragraph">
<p>In Knative serving, things are driven via a <a href="https://github.com/knative/serving/blob/master/docs/spec/spec.md#configuration">Configuration</a> to make a separation between code (container images) and config. One of the good practices in configuration management is that we should always be able to rollback the application state to any “last known good configuration”, to be able to allow this type of rollback Knative creates an unique revision for each and every configuration change.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.0.1<br>
Last updated 2019-02-03 13:53:16 IST
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>